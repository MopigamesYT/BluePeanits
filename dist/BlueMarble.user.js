// ==UserScript==
// @name         Blue Peanits
// @namespace    https://github.com/MopigamesYT/
// @version      0.82.0
// @description  A userscript to automate and/or enhance the user experience on Wplace.live. Make sure to comply with the site's Terms of Service, and rules! This script is not affiliated with Wplace.live in any way, use at your own risk. This script is not affiliated with TamperMonkey. The author of this userscript is not responsible for any damages, issues, loss of data, or punishment that may occur as a result of using this script. This script is provided "as is" under the MPL-2.0 license. The "Blue Marble" icon is licensed under CC0 1.0 Universal (CC0 1.0) Public Domain Dedication. The image is owned by NASA.
// @author       MopigamesYT
// @license      MPL-2.0
// @icon         https://raw.githubusercontent.com/SwingTheVine/Wplace-BlueMarble/a3b4a288514dc48a9232b1aeeb6b377af6fdfe7c/dist/assets/Favicon.png
// @run-at       document-start
// @match        *://*.wplace.live/*
// @grant        GM_addStyle
// @grant        GM.setValue
// @grant        GM_getValue
// ==/UserScript==

// Wplace  --> https://wplace.live
// License --> https://www.mozilla.org/en-US/MPL/2.0/

"use strict";(()=>{var t,e,n=t=>{throw TypeError(t)},o=(t,e,o)=>e.has(t)?n("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,o),i=(t,e,o)=>(((t,e)=>{e.has(t)||n("Cannot access private method")})(t,e),o),a=class{constructor(e,n){o(this,t),this.name=e,this.version=n,this.t=null,this.o="bm-b",this.i=null,this.l=null,this.m=[]}p(t){this.t=t}u(){return this.m.length>0&&(this.l=this.m.pop()),this}h(t){t?.appendChild(this.i),this.i=null,this.l=null,this.m=[]}v(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"div",{},n)),this}k(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"p",{},n)),this}$(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"small",{},n)),this}T(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"img",{},n)),this}M(n,o={},a=()=>{}){return a(this,i(this,t,e).call(this,"h"+n,{},o)),this}C(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"hr",{},n)),this}S(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"br",{},n)),this}I(n={},o=()=>{}){const a=i(this,t,e).call(this,"label",{textContent:n.textContent??""});delete n.textContent;const s=i(this,t,e).call(this,"input",{type:"checkbox"},n);return a.insertBefore(s,a.firstChild),this.u(),o(this,a,s),this}N(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"button",{},n)),this}A(n={},o=()=>{}){const a=n.title??n.textContent??"Help: No info";delete n.textContent,n.title=`Help: ${a}`;const s={textContent:"?",className:"bm-q",onclick:()=>{this.D(this.o,a)}};return o(this,i(this,t,e).call(this,"button",s,n)),this}B(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"input",{},n)),this}O(n={},o=()=>{}){const a=n.textContent??"";delete n.textContent;const s=i(this,t,e).call(this,"div"),r=i(this,t,e).call(this,"input",{type:"file",style:"display: none !important; visibility: hidden !important; position: absolute !important; left: -9999px !important; width: 0 !important; height: 0 !important; opacity: 0 !important;"},n);this.u();const l=i(this,t,e).call(this,"button",{textContent:a});return this.u(),this.u(),r.setAttribute("tabindex","-1"),r.setAttribute("aria-hidden","true"),l.addEventListener("click",()=>{r.click()}),r.addEventListener("change",()=>{l.style.maxWidth=`${l.offsetWidth}px`,r.files.length>0?l.textContent=r.files[0].name:l.textContent=a}),o(this,s,r,l),this}j(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"textarea",{},n)),this}D(t,e,n=!1){const o=document.getElementById(t.replace(/^#/,""));o&&(o instanceof HTMLInputElement?o.value=e:n?o.textContent=e:o.innerHTML=e)}F(t,e){let n,o=!1,i=0,a=null,s=0,r=0,l=0,m=0;if(t=document.querySelector("#"==t?.[0]?t:"#"+t),e=document.querySelector("#"==e?.[0]?e:"#"+e),!t||!e)return void this.L(`Can not drag! ${t?"":"moveMe"} ${t||e?"":"and "}${e?"":"iMoveThings "}was not found!`);const c=()=>{if(o){const e=Math.abs(s-l),n=Math.abs(r-m);(e>.5||n>.5)&&(s=l,r=m,t.style.transform=`translate(${s}px, ${r}px)`,t.style.left="0px",t.style.top="0px",t.style.right=""),a=requestAnimationFrame(c)}};let d=null;const b=(b,p)=>{o=!0,d=t.getBoundingClientRect(),n=b-d.left,i=p-d.top;const u=window.getComputedStyle(t).transform;if(u&&"none"!==u){const t=new DOMMatrix(u);s=t.m41,r=t.m42}else s=d.left,r=d.top;l=s,m=r,document.body.style.userSelect="none",e.classList.add("dragging"),a&&cancelAnimationFrame(a),c()},p=()=>{o=!1,a&&(cancelAnimationFrame(a),a=null),document.body.style.userSelect="",e.classList.remove("dragging")};e.addEventListener("mousedown",function(t){t.preventDefault(),b(t.clientX,t.clientY)}),e.addEventListener("touchstart",function(t){const e=t?.touches?.[0];e&&(b(e.clientX,e.clientY),t.preventDefault())},{passive:!1}),document.addEventListener("mousemove",function(t){o&&d&&(l=t.clientX-n,m=t.clientY-i)},{passive:!0}),document.addEventListener("touchmove",function(t){if(o&&d){const e=t?.touches?.[0];if(!e)return;l=e.clientX-n,m=e.clientY-i,t.preventDefault()}},{passive:!1}),document.addEventListener("mouseup",p),document.addEventListener("touchend",p),document.addEventListener("touchcancel",p)}P(t){(0,console.info)(`${this.name}: ${t}`),this.D(this.o,"Status: "+t,!0)}L(t){(0,console.error)(`${this.name}: ${t}`),this.D(this.o,"Error: "+t,!0)}};function s(t,e){if(0===t)return e[0];let n="";const o=e.length;for(;t>0;)n=e[t%o]+n,t=Math.floor(t/o);return n}function r(t){let e="";for(let n=0;n<t.length;n++)e+=String.fromCharCode(t[n]);return btoa(e)}function l(t){const e=atob(t),n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return n}t=new WeakSet,e=function(t,e={},n={}){const o=document.createElement(t);this.i?(this.l?.appendChild(o),this.m.push(this.l),this.l=o):(this.i=o,this.l=o);for(const[t,n]of Object.entries(e))o[t]=n;for(const[t,e]of Object.entries(n))o[t]=e;return o};var m,c,d,b,p=class{constructor({displayName:t="My template",X:e=0,Y:n="",url:o="",file:i=null,coords:a=null,G:s=null,H:r=1e3,enabled:l=!0}={}){this.displayName=t,this.X=e,this.Y=n,this.url=o,this.file=i,this.coords=a,this.G=s,this.H=r,this.pixelCount=0,this.enabled=l}async R(){console.log("Template coordinates:",this.coords);const t=await createImageBitmap(this.file),e=t.width,n=t.height,o=e*n;console.log(`Template pixel analysis - Dimensions: ${e}×${n} = ${o.toLocaleString()} pixels`),this.pixelCount=o;const i={},a={},s=new OffscreenCanvas(this.H,this.H),l=s.getContext("2d",{J:!0});for(let o=this.coords[3];o<n+this.coords[3];){const m=Math.min(this.H-o%this.H,n-(o-this.coords[3]));console.log(`Math.min(${this.H} - (${o} % ${this.H}), ${n} - (${o-this.coords[3]}))`);for(let n=this.coords[2];n<e+this.coords[2];){console.log(`Pixel X: ${n}\nPixel Y: ${o}`);const c=Math.min(this.H-n%this.H,e-(n-this.coords[2]));console.log(`Math.min(${this.H} - (${n} % ${this.H}), ${e} - (${n-this.coords[2]}))`),console.log(`Draw Size X: ${c}\nDraw Size Y: ${m}`);const d=3*c,b=3*m;s.width=d,s.height=b,console.log(`Draw X: ${c}\nDraw Y: ${m}\nCanvas Width: ${d}\nCanvas Height: ${b}`),l.imageSmoothingEnabled=!1,console.log(`Getting X ${n}-${n+c}\nGetting Y ${o}-${o+m}`),l.clearRect(0,0,d,b),l.drawImage(t,n-this.coords[2],o-this.coords[3],c,m,0,0,3*c,3*m);const p=l.getImageData(0,0,d,b);for(let t=0;t<b;t++)for(let e=0;e<d;e++){const n=4*(t*d+e);222===p.data[n]&&250===p.data[n+1]&&206===p.data[n+2]?(e+t)%2==0?(p.data[n]=0,p.data[n+1]=0,p.data[n+2]=0,p.data[n+3]=32):p.data[n+3]=0:e%3==1&&t%3==1||(p.data[n+3]=0)}console.log(`Shreaded pixels for ${n}, ${o}`,p),l.putImageData(p,0,0);const u=`${(this.coords[0]+Math.floor(n/1e3)).toString().padStart(4,"0")},${(this.coords[1]+Math.floor(o/1e3)).toString().padStart(4,"0")},${(n%1e3).toString().padStart(3,"0")},${(o%1e3).toString().padStart(3,"0")}`;i[u]=await createImageBitmap(s);const h=await s.convertToBlob(),g=await h.arrayBuffer(),f=Array.from(new Uint8Array(g));a[u]=r(f),console.log(i),n+=c}o+=m}return console.log("Template Tiles: ",i),console.log("Template Tiles Buffers: ",a),{V:i,U:a}}};m=new WeakSet,c=async function(){GM.setValue("bmTemplates",JSON.stringify(this.q));try{localStorage.setItem("BlueMarbleTemplates",JSON.stringify(this.q))}catch(t){console.warn("[BlueMarble] Failed to write localStorage backup for templates:",t)}},d=async function(t){console.log("Parsing BlueMarble...");const e=t.templates;if(console.log(`BlueMarble length: ${Object.keys(e).length}`),Object.keys(e).length>0)for(const t in e){const n=t,o=e[t];if(console.log(n),e.hasOwnProperty(t)){const t=n.split(" "),e=Number(t?.[0]),a=t?.[1]||"0",s=o.name||`Template ${e||""}`,r=void 0===o.enabled||o.enabled,c=o.tiles,d={};for(const t in c)if(console.log(t),c.hasOwnProperty(t)){const e=l(c[t]),n=new Blob([e],{type:"image/png"}),o=await createImageBitmap(n);d[t]=o}const u=new p({displayName:s,X:e||this._?.length||0,Y:a||"",enabled:r});if(u.G=d,"number"==typeof o.pixelCount&&o.pixelCount>=0)u.pixelCount=o.pixelCount;else try{u.pixelCount=await i(this,m,b).call(this,d),o.pixelCount=u.pixelCount}catch(t){console.warn("[BlueMarble] Failed to compute precise pixel count; falling back to heuristic:",t);const e=Object.keys(d).length||1;u.pixelCount=500*e,o.pixelCount=u.pixelCount}this._.push(u),console.log(this._),console.log("^^^ This ^^^")}}},b=async function(t){let e=0;const n="undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas"),o=n.getContext("2d",{J:!0});for(const i of Object.keys(t)){const a=t[i];if(!a)continue;n.width=a.width,n.height=a.height,o.clearRect(0,0,a.width,a.height),o.drawImage(a,0,0);const{data:s,width:r,height:l}=o.getImageData(0,0,a.width,a.height);for(let t=1;t<l;t+=3)for(let n=1;n<r;n+=3)s[4*(t*r+n)+3]>0&&e++}return e};var u=GM_info.script.name.toString(),h=GM_info.script.version.toString();!function(t){const e=document.createElement("script");e.setAttribute("bm-r",u),e.setAttribute("bm-o","color: cornflowerblue;"),e.textContent=`(${t})();`,document.documentElement?.appendChild(e),e.remove()}(()=>{const t=document.currentScript,e=t?.getAttribute("bm-r")||"Blue Peanits",n=t?.getAttribute("bm-o")||"",o=new Map;window.addEventListener("message",t=>{const{source:i,endpoint:a,blobID:s,blobData:r,blink:l}=t.data,m=Date.now()-l;if(console.groupCollapsed(`%c${e}%c: ${o.size} Recieved IMAGE message about blob "${s}"`,n,""),console.log(`Blob fetch took %c${String(Math.floor(m/6e4)).padStart(2,"0")}:${String(Math.floor(m/1e3)%60).padStart(2,"0")}.${String(m%1e3).padStart(3,"0")}%c MM:SS.mmm`,n,""),console.log(o),console.groupEnd(),"blue-marble"==i&&s&&r&&!a){const t=o.get(s);"function"==typeof t?t(r):function(...t){(0,console.warn)(...t)}(`%c${e}%c: Attempted to retrieve a blob (%s) from queue, but the blobID was not a function! Skipping...`,n,"",s),o.delete(s)}});const i=window.fetch;window.fetch=async function(...t){const a=await i.apply(this,t),s=a.clone(),r=(t[0]instanceof Request?t[0]?.url:t[0])||"ignore",l=s.headers.get("content-type")||"";if(l.includes("application/json"))console.log(`%c${e}%c: Sending JSON message about endpoint "${r}"`,n,""),s.json().then(t=>{window.postMessage({source:"blue-marble",endpoint:r,jsonData:t},"*")}).catch(t=>{console.error(`%c${e}%c: Failed to parse JSON: `,n,"",t)});else if(l.includes("image/")&&!r.includes("openfreemap")&&!r.includes("maps")){const t=Date.now(),i=await s.blob();return console.log(`%c${e}%c: ${o.size} Sending IMAGE message about endpoint "${r}"`,n,""),new Promise(a=>{const l=crypto.randomUUID();o.set(l,t=>{a(new Response(t,{headers:s.headers,status:s.status,statusText:s.statusText})),console.log(`%c${e}%c: ${o.size} Processed blob "${l}"`,n,"")}),window.postMessage({source:"blue-marble",endpoint:r,blobID:l,blobData:i,blink:t})}).catch(i=>{const a=Date.now();console.error(`%c${e}%c: Failed to Promise blob!`,n,""),console.groupCollapsed(`%c${e}%c: Details of failed blob Promise:`,n,""),console.log(`Endpoint: ${r}\nThere are ${o.size} blobs processing...\nBlink: ${t.toLocaleString()}\nTime Since Blink: ${String(Math.floor(a/6e4)).padStart(2,"0")}:${String(Math.floor(a/1e3)%60).padStart(2,"0")}.${String(a%1e3).padStart(3,"0")} MM:SS.mmm`),console.error("Exception stack:",i),console.groupEnd()})}return a}}),GM_addStyle('#bm-n{position:fixed;background-color:rgba(21,48,99,0.9);color:white;padding:10px;border-radius:8px;z-index:9000;transition:all 0.3s ease,transform 0s;max-width:300px;width:auto;will-change:transform;backface-visibility:hidden;-webkit-backface-visibility:hidden;transform-style:preserve-3d;-webkit-transform-style:preserve-3d}#bm-4,#bm-n hr,#bm-3,#bm-1{transition:opacity 0.2s ease,height 0.2s ease}div#bm-n{font-family:\'Roboto Mono\',\'Courier New\',\'Monaco\',\'DejaVu Sans Mono\',monospace,\'Arial\';letter-spacing:0.05em}#bm-i{margin-bottom:0.5em;background:url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="5" height="5"><circle cx="3" cy="3" r="1.5" fill="CornflowerBlue" /></svg>\') repeat;cursor:grab;width:100%;height:1em;transition:margin-bottom 0.2s ease}#bm-i.dragging{cursor:grabbing;pointer-events:auto}#bm-n:has(#bm-i.dragging){pointer-events:none;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}#bm-7{margin-bottom:0.5em}#bm-7[style*="text-align: center"]{display:flex;flex-direction:column;align-items:center;justify-content:center}#bm-n[style*="padding: 5px"]{width:auto!important;max-width:300px;min-width:200px}#bm-n img{display:inline-block;height:2.5em;margin-right:1ch;vertical-align:middle;transition:opacity 0.2s ease}#bm-7[style*="text-align: center"] img{margin-right:0;margin-left:0;display:block;margin:0 auto}#bm-n h1{display:inline-block;font-size:x-large;font-weight:bold;vertical-align:middle}#bm-3 input[type="checkbox"]{vertical-align:middle;margin-right:0.5ch}#bm-3 label{margin-right:0.5ch}.bm-q{border:white 1px solid;height:1.5em;width:1.5em;margin-top:2px;text-align:center;line-height:1em;padding:0!important}#bm-d{vertical-align:middle}#bm-d svg{width:50%;margin:0 auto;fill:#111}#bm-O{display:flex;gap:0.5ch;align-items:center}#bm-G{background-color:#666;font-size:0.7em;padding:0.1em 0.3em;border-radius:0.5em;transition:background-color 0.2s ease}#bm-G.active{background-color:#4CAF50}#bm-G:hover{background-color:#777}#bm-G.active:hover{background-color:#45a049}#bm-J{background-color:#444!important;border:1px solid #666!important;transition:all 0.2s ease}#bm-J.active{background-color:#1a1a1a!important;border-color:#888!important}#bm-J:hover{background-color:#555!important}#bm-J.active:hover{background-color:#333!important}div:has(> #bm-S){display:flex;gap:0.5ch}#bm-T svg,#bm-U svg{height:1em;margin:0 auto;margin-top:2px;text-align:center;line-height:1em;vertical-align:bottom}#bm-8 input[type="number"]{appearance:auto;-moz-appearance:textfield;width:5.5ch;margin-left:1ch;background-color:rgba(0,0,0,0.2);padding:0 0.5ch;font-size:small}#bm-8 input[type="number"]::-webkit-outer-spin-button,#bm-8 input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}#bm-0{display:grid;grid-template-columns:1fr 1fr;gap:0.5em;align-items:center}#bm-16{grid-column:1/-1;margin-bottom:0.5em}div:has(> #bm-2) > button{width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}#bm-2,input[type="file"][id*="template"]{display:none!important;visibility:hidden!important;position:absolute!important;left:-9999px!important;top:-9999px!important;width:0!important;height:0!important;opacity:0!important;z-index:-9999!important;pointer-events:none!important}#bm-b{font-size:small;background-color:rgba(0,0,0,0.2);padding:0 0.5ch;height:3.75em;width:100%}#bm-1{display:flex;justify-content:space-between}#bm-n small{font-size:x-small;color:lightgray}#bm-4,#bm-3,#bm-8,#bm-0,div:has(> #bm-2),#bm-b{margin-top:0.5em}#bm-n button{background-color:#144eb9;border-radius:1em;padding:0 0.75ch}#bm-n button:hover,#bm-n button:focus-visible{background-color:#1061e5}#bm-n button:active,#bm-n button:disabled{background-color:#2e97ff}#bm-n button:disabled{text-decoration:line-through}#bm-P{position:fixed;background-color:rgba(21,48,99,0.95);color:white;padding:15px;border-radius:8px;z-index:9001;max-width:450px;min-width:400px;max-height:80vh;overflow:hidden;font-family:\'Roboto Mono\',\'Courier New\',\'Monaco\',\'DejaVu Sans Mono\',monospace,\'Arial\';letter-spacing:0.05em;box-shadow:0 4px 20px rgba(0,0,0,0.3);transition:all 0.3s ease,transform 0s;will-change:transform;backface-visibility:hidden;-webkit-backface-visibility:hidden;transform-style:preserve-3d;-webkit-transform-style:preserve-3d}#bm-17{margin-bottom:0.5em;background:url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="5" height="5"><circle cx="3" cy="3" r="1.5" fill="CornflowerBlue" /></svg>\') repeat;cursor:grab;width:100%;height:1em}#bm-17.dragging{cursor:grabbing}#bm-K{display:flex;gap:0.5em;margin-bottom:1em}#bm-K button{flex:1;background-color:#144eb9;border-radius:1em;padding:0.5em;font-size:0.9em}#bm-K button:hover{background-color:#1061e5}#bm-18{max-height:300px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#144eb9 rgba(0,0,0,0.2)}#bm-18::-webkit-scrollbar{width:8px}#bm-18::-webkit-scrollbar-track{background:rgba(0,0,0,0.2);border-radius:4px}#bm-18::-webkit-scrollbar-thumb{background:#144eb9;border-radius:4px}#bm-18::-webkit-scrollbar-thumb:hover{background:#1061e5}.bm-19{transition:all 0.2s ease}.bm-19:hover{background-color:rgba(0,0,0,0.35)!important;transform:translateX(2px)}#bm-Z{font-size:0.9em;color:#ccc}#bm-Z p{margin:0.25em 0}#bm--{background-color:#d32f2f!important;color:white;border:none;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-weight:bold}#bm--:hover{background-color:#f44336!important}body.bm-1n{background-color:#1a1a1a!important;color:#e0e0e0!important;color-scheme:dark!important;--color-base-100:rgb(26,26,26)!important;--color-base-200:oklch(15% .011 259.822)!important;--color-base-300:oklch(20% .016 262.751)!important;--color-base-content:oklch(85% .053 255.824)!important;--color-primary:oklch(65% .255 257.57)!important;--color-primary-content:oklch(15% .051 257.57)!important;--color-secondary:oklch(50% .161 282.339)!important;--color-secondary-content:oklch(20% .032 282.339)!important;--color-accent:oklch(70% .191 335.171)!important;--color-accent-content:oklch(15% .038 335.171)!important;--color-neutral:oklch(80% .063 257.651)!important;--color-neutral-content:oklch(25% .012 257.651)!important;--color-info:oklch(70% .085 214.515)!important;--color-info-content:oklch(15% .017 214.515)!important;--color-success:oklch(65% .077 197.823)!important;--color-success-content:oklch(15% .015 197.823)!important;--color-warning:oklch(75% .045 71.47)!important;--color-warning-content:oklch(15% .009 71.47)!important;--color-error:oklch(65% .11 20.076)!important;--color-error-content:oklch(15% .022 20.076)!important}body.bm-1n *{color:#e0e0e0!important}body.bm-1n .navbar,body.bm-1n .navbar-brand,body.bm-1n .nav-link{background-color:#2d2d2d!important;border-color:#444!important}body.bm-1n .btn{background-color:#444!important;border-color:#666!important;color:#e0e0e0!important}body.bm-1n .btn:hover{background-color:#555!important}body.bm-1n .card,body.bm-1n .modal-content{background-color:#2d2d2d!important;border-color:#444!important}body.bm-1n input,body.bm-1n select,body.bm-1n textarea{background-color:#333!important;border-color:#555!important;color:#e0e0e0!important}body.bm-1n .bg-light{background-color:#333!important}body.bm-1n .text-dark{color:#e0e0e0!important}body.bm-1n .border{border-color:#444!important}body.bm-1n .container,body.bm-1n .row,body.bm-1n .col{background-color:transparent!important}#bm-1a{position:fixed;background-color:rgba(21,48,99,0.98);color:white;padding:20px;border-radius:10px;z-index:9002;max-width:600px;min-width:500px;max-height:85vh;overflow-y:auto;font-family:\'Roboto Mono\',\'Courier New\',\'Monaco\',\'DejaVu Sans Mono\',monospace,\'Arial\';letter-spacing:0.05em;box-shadow:0 6px 30px rgba(0,0,0,0.4);transition:all 0.3s ease}#bm-1a .info-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1em;border-bottom:1px solid rgba(255,255,255,0.3);padding-bottom:0.5em}#bm-1a .info-preview{text-align:center;margin:1em 0;background:rgba(0,0,0,0.3);border-radius:6px;padding:1em}#bm-1a .info-preview canvas{max-width:100%;max-height:200px;border:1px solid #666;border-radius:4px;image-rendering:pixelated}#bm-1a .info-section{margin:1em 0;padding:0.75em;background:rgba(0,0,0,0.2);border-radius:6px}#bm-1a .info-section h4{margin:0 0 0.5em 0;color:#87CEEB;font-size:1em}#bm-1a .color-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:0.5em;margin-top:0.5em}#bm-1a .color-item{display:flex;align-items:center;gap:0.5em;padding:0.3em;background:rgba(255,255,255,0.1);border-radius:3px}#bm-1a .color-swatch{width:20px;height:20px;border-radius:3px;border:1px solid #666;flex-shrink:0}#bm-1a .color-info{font-size:0.8em;flex:1;min-width:0}#bm-1a .info-stats{display:grid;grid-template-columns:1fr 1fr;gap:1em}#bm-1a .stat-item{text-align:center;padding:0.5em;background:rgba(255,255,255,0.1);border-radius:4px}#bm-1a .stat-value{font-size:1.2em;font-weight:bold;color:#87CEEB}#bm-1a .stat-label{font-size:0.8em;opacity:0.8}#bm-1a input[type="number"]{appearance:textfield;-moz-appearance:textfield}#bm-1a input[type="number"]::-webkit-outer-spin-button,#bm-1a input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}#bm-1a button:hover{opacity:0.8;transform:translateY(-1px)}');var g=document.createElement("link");g.href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap",g.rel="preload",g.as="style",g.onload=function(){this.onload=null,this.rel="stylesheet"},document.head?.appendChild(g),new class{constructor(){this.W=null,this.Z=null,this.K="#bm-5"}tt(t){return this.Z=t,this.W=new MutationObserver(t=>{for(const e of t)for(const t of e.addedNodes)t instanceof HTMLElement&&t.matches?.(this.K)}),this}et(){return this.W}observe(t,e=!1,n=!1){t.observe(this.Z,{childList:e,subtree:n})}};var f=new a(u,h),y=new a(u,h),w=new class{constructor(t,e,n){o(this,m),this.name=t,this.version=e,this.i=n,this.nt="1.0.0",this.ot=null,this.it="!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~",this.H=1e3,this.st=3,this.rt=!1,this.lt=null,this.ct=null,this.dt="bm-p",this.bt="div#map canvas.maplibregl-canvas",this.ut=null,this.ht="",this._=[],this.q=null,this.gt=!0}ft(){if(document.body.contains(this.lt))return this.lt;document.getElementById(this.dt)?.remove();const t=document.querySelector(this.bt),e=document.createElement("canvas");return e.id=this.dt,e.className="maplibregl-canvas",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.height=t?.clientHeight*(window.devicePixelRatio||1)+"px",e.style.width=t?.clientWidth*(window.devicePixelRatio||1)+"px",e.height=t?.clientHeight*(window.devicePixelRatio||1),e.width=t?.clientWidth*(window.devicePixelRatio||1),e.style.zIndex="8999",e.style.pointerEvents="none",t?.parentElement?.appendChild(e),this.lt=e,window.addEventListener("move",this.yt),window.addEventListener("zoom",this.wt),window.addEventListener("resize",this.vt),this.lt}async xt(){return{whoami:this.name.replace(" ",""),scriptVersion:this.version,schemaVersion:this.nt,templates:{}}}async kt(t,e,n){this.q||(this.q=await this.xt(),console.log("Creating JSON...")),this.i.P(`Creating template at ${n.join(", ")}...`);const o=new p({displayName:e,X:Object.keys(this.q.templates).length||0,Y:s(this.ot||0,this.it),file:t,coords:n}),{V:a,U:r}=await o.R(this.H);o.G=a,this.q.templates[`${o.X} ${o.Y}`]={name:o.displayName,coords:n.join(", "),enabled:!0,tiles:r,pixelCount:o.pixelCount},this._.push(o);const l=(new Intl.NumberFormat).format(o.pixelCount);this.i.P(`Template created at ${n.join(", ")}! Total pixels: ${l}`),console.log(Object.keys(this.q.templates).length),console.log(this.q),console.log(this._),console.log(JSON.stringify(this.q)),await i(this,m,c).call(this)}async $t(t){this.q||(this.q=await this.xt()),this.q.templates[t]&&delete this.q.templates[t];const[e,n]=t.split(" ");this._=this._.filter(t=>!(t.X==Number(e)&&t.Y===n)),await i(this,m,c).call(this)}async Tt(t,e){this.q||(this.q=await this.xt()),this.q.templates[t]&&(this.q.templates[t].enabled=e);const[n,o]=t.split(" "),a=this._.find(t=>t.X==Number(n)&&t.Y===o);a&&(a.enabled=e),await i(this,m,c).call(this)}async Mt(t,e){if(this.q||(this.q=await this.xt()),!Array.isArray(e)||4!==e.length)throw new Error("Coordinates must be an array of 4 numbers [tileX, tileY, pixelX, pixelY]");const[n,o,a,s]=e.map(Number);if(![n,o,a,s].every(t=>!isNaN(t)&&isFinite(t)))throw new Error("All coordinates must be valid numbers");this.q.templates[t]&&(this.q.templates[t].coords=e.join(", "));const[r,l]=t.split(" "),d=this._.find(t=>t.X==Number(r)&&t.Y===l);return d&&(d.coords=e),await i(this,m,c).call(this),`Template coordinates updated to: ${e.join(", ")}`}Ct(){return this.q&&this.q.templates?Object.entries(this.q.templates).map(([t,e])=>({key:t,name:e.name,coords:e.coords,enabled:e.enabled,pixelCount:this._.find(e=>`${e.X} ${e.Y}`===t)?.pixelCount||e.pixelCount||0})):[]}async St(t,e){if(!this.gt)return t;const n=this.H*this.st;e=e[0].toString().padStart(4,"0")+","+e[1].toString().padStart(4,"0"),console.log(`Searching for templates in tile: "${e}"`);const o=this._;console.log(o),o.sort((t,e)=>t.X-e.X),console.log(o);const i=o.filter(t=>t.enabled).map(t=>{const n=Object.keys(t.G).filter(t=>t.startsWith(e));if(0===n.length)return null;const o=n.map(e=>{const n=e.split(",");return{It:t.G[e],Nt:[n[0],n[1]],zt:[n[2],n[3]]}});return o?.[0]}).filter(Boolean);console.log(i);const a=i?.length||0;if(console.log(`templateCount = ${a}`),a>0){const t=o.filter(t=>Object.keys(t.G).filter(t=>t.startsWith(e)).length>0&&t.enabled).reduce((t,e)=>t+(e.pixelCount||0),0),n=(new Intl.NumberFormat).format(t);this.i.P(`Displaying ${a} template${1==a?"":"s"}.\nTotal pixels: ${n}`)}else this.i.P(`Displaying ${a} templates.`);const s=await createImageBitmap(t),r=new OffscreenCanvas(n,n),l=r.getContext("2d");l.imageSmoothingEnabled=!1,l.beginPath(),l.rect(0,0,n,n),l.clip(),l.clearRect(0,0,n,n),l.drawImage(s,0,0,n,n);for(const t of i)console.log("Template:"),console.log(t),l.drawImage(t.It,Number(t.zt[0])*this.st,Number(t.zt[1])*this.st);return await r.convertToBlob({type:"image/png"})}async At(t){console.log("Importing JSON..."),console.log(t);const e=(this.name||"").replace(/\s+/g,""),n=["BlueMarble","BluePeanits","BluePeanuts",e];if(!t?.whoami&&t?.templates&&"object"==typeof t.templates&&(t.whoami=e),t&&n.includes(t?.whoami)){if(this.q){if(t?.templates)for(const e of Object.keys(t.templates))this.q.templates[e]||(this.q.templates[e]=t.templates[e])}else this.q=t;await i(this,m,d).call(this,t).catch(t=>console.error("[BlueMarble] Failed to parse templates:",t))}else console.warn(`Template JSON 'whoami' ("${t?.whoami}") did not match any accepted identifiers: ${n.join(", ")}`)}async Dt(t,e){this.q||(this.q=await this.xt()),this.q.templates[t]&&(this.q.templates[t].name=e);const[n,o]=t.split(" "),a=this._.find(t=>t.X==Number(n)&&t.Y===o);a&&(a.displayName=e),await i(this,m,c).call(this)}Bt(t){this.gt=t}async Ot(t){const e=this.Ct();for(const n of e)await this.Tt(n.key,t)}}(u,h,f),v=new class{constructor(t){this.jt=t,this.Et=!1,this.Ft=[],this.Lt=[]}Pt(t){window.addEventListener("message",async e=>{const n=e.data,o=n.jsonData;if(!n||"blue-marble"!==n.source)return;if(!n.endpoint)return;const i=n.endpoint?.split("?")[0].split("/").filter(t=>t&&isNaN(Number(t))).filter(t=>t&&!t.includes(".")).pop();switch(console.log('%cBlue Peanits%c: Recieved message about "%s"',"color: cornflowerblue;","",i),i){case"me":if(o.status&&"2"!=o.status?.toString()[0])return void t.L("You are not logged in!\nCould not fetch userdata.");const e=Math.ceil(Math.pow(Math.floor(o.level)*Math.pow(30,.65),1/.65)-o.pixelsPainted);console.log(o.id),(o.id||0===o.id)&&console.log(s(o.id,"!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~")),this.jt.ot=o.id,t.D("bm-h",`Username: <b>${function(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}(o.name)}</b>`),t.D("bm-c",`Droplets: <b>${(new Intl.NumberFormat).format(o.droplets)}</b>`),t.D("bm-6",`Next level in <b>${(new Intl.NumberFormat).format(e)}</b> pixel${1==e?"":"s"}`);break;case"pixel":const i=n.endpoint.split("?")[0].split("/").filter(t=>t&&!isNaN(Number(t))),l=new URLSearchParams(n.endpoint.split("?")[1]),m=[l.get("x"),l.get("y")];if(this.Ft.length&&(!i.length||!m.length))return void t.L("Coordinates are malformed!\nDid you try clicking the canvas first?");this.Ft=[...i,...m];const c=(a=i,r=m,[parseInt(a[0])%4*1e3+parseInt(r[0]),parseInt(a[1])%4*1e3+parseInt(r[1])]);this.jt.rt&&(t.D("bm-j",i[0]||""),t.D("bm-k",i[1]||""),t.D("bm-l",m[0]||""),t.D("bm-m",m[1]||""));const d=document.querySelectorAll("span");for(const t of d)if(t.textContent.trim().includes(`${c[0]}, ${c[1]}`)){let e=document.querySelector("#bm-5");const n=`(Tl X: ${i[0]}, Tl Y: ${i[1]}, Px X: ${m[0]}, Px Y: ${m[1]})`;e?e.textContent=n:(e=document.createElement("span"),e.id="bm-5",e.textContent=n,e.style="margin-left: calc(var(--spacing)*3); font-size: small;",t.parentNode.parentNode.parentNode.insertAdjacentElement("afterend",e))}break;case"tiles":let b=n.endpoint.split("/");b=[parseInt(b[b.length-2]),parseInt(b[b.length-1].replace(".png",""))];const p=n.blobID,u=n.blobData,h=await this.jt.St(u,b);window.postMessage({source:"blue-marble",blobID:p,blobData:h,blink:n.blink});break;case"robots":this.Et="false"==o.userscript?.toString().toLowerCase();break}var a,r})}}(w);f.p(v);var x={};try{x=JSON.parse(GM_getValue("bmTemplates","{}"))||{}}catch(t){console.warn("[BlueMarble] Failed to parse GM stored templates:",t),x={}}if(!x.templates||0===Object.keys(x.templates||{}).length)try{const t=localStorage.getItem("BlueMarbleTemplates");if(t){const e=JSON.parse(t);e&&e.templates&&Object.keys(e.templates).length&&(console.info("[BlueMarble] Migrating templates from localStorage backup."),x=e)}}catch(t){console.warn("[BlueMarble] Failed localStorage migration attempt:",t)}console.log(x),Promise.resolve(w.At(x)).then(()=>console.info("[BlueMarble] Templates imported")).catch(t=>console.error("[BlueMarble] Template import failed",t)),function(){let t=!1;f.v({id:"bm-n",style:"top: 10px; right: 75px;"}).v({id:"bm-7"}).v({id:"bm-i"}).u().T({alt:"Blue Peanits Icon - Click to minimize/maximize",src:"https://raw.githubusercontent.com/SwingTheVine/Wplace-BlueMarble/main/dist/assets/Favicon.png",style:"cursor: pointer;"},(e,n)=>{n.addEventListener("click",()=>{t=!t;const o=document.querySelector("#bm-n"),i=document.querySelector("#bm-7"),a=document.querySelector("#bm-i"),s=document.querySelector("#bm-8"),r=document.querySelector("#bm-d"),l=document.querySelector("#bm-G"),m=document.querySelector("#bm-16"),c=document.querySelector("#bm-e"),d=document.querySelector("#bm-f"),b=document.querySelector("#bm-9"),p=document.querySelectorAll("#bm-8 input");t||(o.style.width="auto",o.style.maxWidth="300px",o.style.minWidth="200px",o.style.padding="10px"),["#bm-n h1","#bm-4","#bm-n hr","#bm-3 > *:not(#bm-8)","#bm-2","#bm-1",`#${e.o}`].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.style.display=t?"none":""})}),t?(s&&(s.style.display="none"),r&&(r.style.display="none"),l&&(l.style.display="none"),m&&(m.style.display="none"),c&&(c.style.display="none"),d&&(d.style.display="none"),b&&(b.style.display="none"),p.forEach(t=>{t.style.display="none"}),o.style.width="60px",o.style.height="76px",o.style.maxWidth="60px",o.style.minWidth="60px",o.style.padding="8px",n.style.marginLeft="3px",i.style.textAlign="center",i.style.margin="0",i.style.marginBottom="0",a&&(a.style.display="",a.style.marginBottom="0.25em")):(s&&(s.style.display="",s.style.flexDirection="",s.style.justifyContent="",s.style.alignItems="",s.style.gap="",s.style.textAlign="",s.style.margin=""),r&&(r.style.display=""),l&&(l.style.display=""),m&&(m.style.display=""),c&&(c.style.display="",c.style.marginTop=""),d&&(d.style.display="",d.style.marginTop=""),b&&(b.style.display="",b.style.marginTop=""),p.forEach(t=>{t.style.display=""}),n.style.marginLeft="",o.style.padding="10px",i.style.textAlign="",i.style.margin="",i.style.marginBottom="",a&&(a.style.marginBottom="0.5em"),o.style.width="",o.style.height=""),n.alt=t?"Blue Peanits Icon - Minimized (Click to maximize)":"Blue Peanits Icon - Maximized (Click to minimize)"})}).u().M(1,{textContent:u}).u().u().C().u().v({id:"bm-4"}).k({id:"bm-h",textContent:"Username:"}).u().k({id:"bm-c",textContent:"Droplets:"}).u().k({id:"bm-6",textContent:"Next level in..."}).u().u().C().u().v({id:"bm-3"}).v({id:"bm-8"}).v({id:"bm-O"}).N({id:"bm-d",className:"bm-q",style:"margin-top: 0;",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 6"><circle cx="2" cy="2" r="2"></circle><path d="M2 6 L3.7 3 L0.3 3 Z"></path><circle cx="2" cy="2" r="0.7" fill="white"></circle></svg></svg>'},(t,e)=>{e.onclick=()=>{const e=t.t?.Ft;e?.[0]?(t.D("bm-j",e?.[0]||""),t.D("bm-k",e?.[1]||""),t.D("bm-l",e?.[2]||""),t.D("bm-m",e?.[3]||"")):t.L("Coordinates are malformed! Did you try clicking on the canvas first?")}}).u().N({id:"bm-G",textContent:"AUTO",title:"Toggle automatic coordinate filling when clicking the map"},(t,e)=>{const n=()=>{t.t?.jt?.rt?(e.classList.add("active"),e.title="Auto-coordinates ON - coordinates will be filled automatically when clicking the map"):(e.classList.remove("active"),e.title="Auto-coordinates OFF - click to enable automatic coordinate filling")};n(),e.onclick=()=>{if(t.t?.jt){t.t.jt.rt=!t.t.jt.rt,n();const e=t.t.jt.rt?"enabled":"disabled";t.P(`Auto-coordinates ${e}!`)}}}).u().u().B({type:"number",id:"bm-j",placeholder:"Tl X",min:0,max:2047,step:1,required:!0}).u().B({type:"number",id:"bm-k",placeholder:"Tl Y",min:0,max:2047,step:1,required:!0}).u().B({type:"number",id:"bm-l",placeholder:"Px X",min:0,max:2047,step:1,required:!0}).u().B({type:"number",id:"bm-m",placeholder:"Px Y",min:0,max:2047,step:1,required:!0}).u().u().O({id:"bm-2",textContent:"Upload Template",accept:"image/png, image/jpeg, image/webp, image/bmp, image/gif"}).u().v({id:"bm-0"}).N({id:"bm-16",textContent:"Manage Templates"},(t,e)=>{const n=()=>{const n=t.t?.jt?.Ct()||[],o=n.filter(t=>t.enabled).length;e.textContent=n.length>0?`Manage (${o}/${n.length})`:"Manage Templates"};e.onclick=o=>{const i=document.querySelector("#bm-P"),a="none"!==i.style.display;if(o.shiftKey){const o=document.querySelector("#bm-n"),i=document.querySelector("#bm-V");if(i)i.remove(),e.style.backgroundColor="",e.style.fontWeight="";else{const i=document.createElement("div");i.id="bm-V",i.innerHTML='\n                  <hr style="margin: 1em 0;">\n                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">\n                    <h3 style="margin: 0; font-size: 1em;">Templates</h3>\n                    <button id="bm-x" style="background: #d32f2f; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9em;">×</button>\n                  </div>\n                  <div id="bm-y" style="max-height: 200px; overflow-y: auto; margin-bottom: 0.5em;"></div>\n                  <div style="display: flex; gap: 0.5em; font-size: 0.8em;">\n                    <button id="bm-L" style="flex: 1; padding: 0.3em;">Enable All</button>\n                    <button id="bm-H" style="flex: 1; padding: 0.3em;">Disable All</button>\n                  </div>\n                ',o.appendChild(i),document.querySelector("#bm-x").onclick=()=>{i.remove(),e.style.backgroundColor="",e.style.fontWeight=""},document.querySelector("#bm-L").onclick=async()=>{await(t.t?.jt?.Ot(!0)),updateInlineList(),t.P("All templates enabled!")},document.querySelector("#bm-H").onclick=async()=>{await(t.t?.jt?.Ot(!1)),updateInlineList(),t.P("All templates disabled!")},window.updateInlineList=()=>{const e=t.t?.jt?.Ct()||[],n=document.querySelector("#bm-y");0!==e.length?n.innerHTML=e.map(t=>`\n                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.3em; margin: 0.2em 0; background: rgba(0,0,0,0.2); border-radius: 3px; border-left: 2px solid ${t.enabled?"#4CAF50":"#f44336"};">\n                      <div style="flex: 1; min-width: 0;">\n                        <div style="font-size: 0.8em; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: ${t.enabled?"#fff":"#999"};">${t.name}</div>\n                        <div style="font-size: 0.7em; color: #bbb;">${t.coords}</div>\n                      </div>\n                      <div style="display: flex; gap: 0.2em;">\n                        <button onclick="toggleInlineTemplate('${t.key}', ${!t.enabled})" style="width: 25px; height: 25px; font-size: 0.8em; background: ${t.enabled?"#4CAF50":"#666"};">${t.enabled?"👁️":"👁️‍🗨️"}</button>\n                        <button onclick="deleteInlineTemplate('${t.key}', '${t.name}')" style="width: 25px; height: 25px; font-size: 0.8em; background: #d32f2f;">🗑️</button>\n                      </div>\n                    </div>\n                  `).join(""):n.innerHTML='<p style="text-align: center; color: #888; margin: 1em 0; font-size: 0.8em;">No templates</p>'},window.toggleInlineTemplate=async(e,o)=>{await(t.t?.jt?.Tt(e,o)),updateInlineList(),n()},window.deleteInlineTemplate=async(e,o)=>{confirm(`Delete "${o}"?`)&&(await(t.t?.jt?.$t(e)),updateInlineList(),n())},updateInlineList(),e.style.backgroundColor="#2e97ff",e.style.fontWeight="bold"}return}i.style.display=a?"none":"block",a?(e.style.backgroundColor="",e.style.fontWeight=""):(refreshTemplateList(),e.style.backgroundColor="#2e97ff",e.style.fontWeight="bold"),n()},n(),setInterval(n,2e3)}).u().N({id:"bm-f",textContent:"Enable All"},(t,e)=>{e.onclick=async()=>{await(t.t?.jt?.Ot(!0)),window.refreshTemplateList&&refreshTemplateList(),t.P("Enabled all templates!")}}).u().N({id:"bm-e",textContent:"Create"},(t,e)=>{e.onclick=()=>{const e=document.querySelector("#bm-2"),n=document.querySelector("#bm-j");if(!n.checkValidity())return n.reportValidity(),void t.L("Coordinates are malformed! Did you try clicking on the canvas first?");const o=document.querySelector("#bm-k");if(!o.checkValidity())return o.reportValidity(),void t.L("Coordinates are malformed! Did you try clicking on the canvas first?");const i=document.querySelector("#bm-l");if(!i.checkValidity())return i.reportValidity(),void t.L("Coordinates are malformed! Did you try clicking on the canvas first?");const a=document.querySelector("#bm-m");if(!a.checkValidity())return a.reportValidity(),void t.L("Coordinates are malformed! Did you try clicking on the canvas first?");if(!e?.files[0])return void t.L("No file selected!");w.kt(e.files[0],e.files[0]?.name.replace(/\.[^/.]+$/,""),[Number(n.value),Number(o.value),Number(i.value),Number(a.value)]),setTimeout(()=>{window.refreshTemplateList&&refreshTemplateList()},100),t.P("Template created!"),e.value="";const s=e.parentElement.querySelector("button");s&&(s.textContent="Upload Template")}}).u().N({id:"bm-9",textContent:"Disable All"},(t,e)=>{e.onclick=async()=>{await(t.t?.jt?.Ot(!1)),window.refreshTemplateList&&refreshTemplateList(),t.P("Disabled all templates!")}}).u().u().j({id:f.o,placeholder:`Status: Sleeping...\nVersion: ${h}`,readOnly:!0}).u().v({id:"bm-1"}).v().N({id:"bm-a",className:"bm-q",innerHTML:"🎨",title:"Template Color Converter"},(t,e)=>{e.addEventListener("click",()=>{window.open("https://pepoafonso.github.io/color_converter_wplace/","_blank","noopener noreferrer")})}).u().N({id:"bm-J",className:"bm-q",innerHTML:"🌙",title:"Toggle dark theme"},(t,e)=>{GM_getValue("darkTheme",!1)&&(document.body.classList.add("bm-1n"),e.classList.add("active")),e.addEventListener("click",()=>{document.body.classList.contains("bm-1n")?(document.body.classList.remove("bm-1n"),e.classList.remove("active"),GM_setValue("darkTheme",!1)):(document.body.classList.add("bm-1n"),e.classList.add("active"),GM_setValue("darkTheme",!0))})}).u().u().$({textContent:"Made by SwingTheVine - Modified by Mopi",style:"margin-top: auto;"}).u().u().u().h(document.body)}(),y.v({id:"bm-P",style:"top: 10px; left: 400px; display: none;"}).v({id:"bm-W"}).v({id:"bm-17"}).u().v({style:"display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;"}).M(2,{textContent:"Template Manager",style:"margin: 0; color: #fff;"}).u().N({id:"bm--",textContent:"×",className:"bm-q",style:"font-size: large; margin: 0;"},(t,e)=>{e.onclick=()=>{const t=document.querySelector("#bm-16");document.querySelector("#bm-P").style.display="none",t&&(t.style.backgroundColor="",t.style.fontWeight="")}}).u().u().u().C({style:"margin: 0.5em 0;"}).u().v({id:"bm-K",style:"margin-bottom: 1em;"}).N({id:"bm-D",textContent:"Enable All"},(t,e)=>{e.onclick=async()=>{await w.Ot(!0),refreshTemplateList(),f.P("All templates enabled!")}}).u().N({id:"bm-z",textContent:"Disable All"},(t,e)=>{e.onclick=async()=>{await w.Ot(!1),refreshTemplateList(),f.P("All templates disabled!")}}).u().u().v({id:"bm-18",style:"max-height: 400px; overflow-y: auto; margin-bottom: 1em;"}).u().C({style:"margin: 0.5em 0;"}).u().v({id:"bm-Z"}).k({id:"bm-A",textContent:"Total templates: 0",style:"margin: 0.25em 0; font-size: 0.9em;"}).u().k({id:"bm-w",textContent:"Enabled templates: 0",style:"margin: 0.25em 0; font-size: 0.9em;"}).u().$({textContent:"Shortcuts: Ctrl+T (toggle), Ctrl+Shift+E (enable all), Ctrl+Shift+D (disable all) • Shift+Click Manage for inline mode",style:"color: #aaa; font-size: 0.7em; margin-top: 0.5em; display: block; line-height: 1.3;"}).u().u().h(document.body),y.F("#bm-P","#bm-17"),window.refreshTemplateList=function(){const t=w.Ct(),e=document.querySelector("#bm-18"),n=document.querySelector("#bm-A"),o=document.querySelector("#bm-w");e.innerHTML="";const i=t.filter(t=>t.enabled);n.textContent=`Total templates: ${t.length}`,o.textContent=`Enabled templates: ${i.length}`,0!==t.length?t.forEach(t=>{const n=document.createElement("div");n.className="bm-19",n.style.cssText=`\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 0.75em;\n        margin: 0.5em 0;\n        background-color: rgba(0, 0, 0, 0.2);\n        border-radius: 6px;\n        border-left: 4px solid ${t.enabled?"#4CAF50":"#f44336"};\n        transition: all 0.2s ease;\n        min-height: 60px;\n      `;const o=document.createElement("div");o.style.cssText="flex: 1; min-width: 0; margin-right: 1em;";const i=document.createElement("div");i.textContent=t.name,i.style.cssText=`\n        font-weight: bold;\n        margin-bottom: 0.4em;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        color: ${t.enabled?"#fff":"#999"};\n        font-size: 1em;\n      `;const a=document.createElement("div");a.style.cssText="font-size: 0.8em; color: #bbb; line-height: 1.3;";const s=(new Intl.NumberFormat).format(t.pixelCount);a.innerHTML=`\n        <div>📍 ${t.coords}</div>\n        <div>🎨 ${s} pixels</div>\n      `,o.appendChild(i),o.appendChild(a);const r=document.createElement("div");r.style.cssText="display: flex; flex-direction: column; gap: 0.3em; align-items: center;";const l=document.createElement("button");l.textContent="ℹ️",l.title="Template information",l.className="bm-q",l.style.cssText="\n        width: 35px;\n        height: 35px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 1.1em;\n        background-color: #2196F3;\n      ",l.onclick=()=>{showTemplateInfo(t)};const m=document.createElement("button");m.textContent=t.enabled?"👁️":"👁️‍🗨️",m.title=t.enabled?"Hide template":"Show template",m.className="bm-q",m.style.cssText=`\n        width: 35px;\n        height: 35px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 1.2em;\n        background-color: ${t.enabled?"#4CAF50":"#666"};\n      `,m.onclick=async()=>{await w.Tt(t.key,!t.enabled),refreshTemplateList(),f.P(`Template "${t.name}" ${t.enabled?"disabled":"enabled"}`)};const c=document.createElement("button");c.textContent="🗑️",c.title="Delete template",c.className="bm-q",c.style.cssText="\n        width: 35px;\n        height: 35px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 1.1em;\n        background-color: #d32f2f;\n      ",c.onclick=async()=>{confirm(`Are you sure you want to delete "${t.name}"?\n\nThis action cannot be undone.`)&&(await w.$t(t.key),refreshTemplateList(),f.P(`Template "${t.name}" deleted`))},r.appendChild(l),r.appendChild(m),r.appendChild(c),n.appendChild(o),n.appendChild(r),e.appendChild(n)}):e.innerHTML='<div style="text-align: center; color: #888; margin: 2em 0; padding: 1em; background-color: rgba(0,0,0,0.1); border-radius: 4px; font-style: italic;">No templates loaded<br><small>Create templates using the main interface</small></div>'},window.showTemplateInfo=async function(t){let e=document.querySelector("#bm-1a");e||(e=document.createElement("div"),e.id="bm-1a",e.style.cssText="top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;",document.body.appendChild(e));const n=w._.find(e=>`${e.X} ${e.Y}`===t.key);e.innerHTML=`\n      <div class="info-header">\n        <h2 style="margin: 0; color: #fff;">Template Information</h2>\n        <button id="bm-1o" class="bm-q" style="width: 30px; height: 30px; background: #d32f2f; font-size: 1.2em;">×</button>\n      </div>\n      \n      <div class="info-section">\n        <h4>📋 Basic Information</h4>\n        <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5em 1em; font-size: 0.9em;">\n          <strong>Name:</strong> \n          <div style="display: flex; gap: 0.5em; align-items: center;">\n            <span id="bm-M">${t.name}</span>\n            <button id="bm-13" class="bm-q" style="width: 25px; height: 25px; background: #2196F3; font-size: 0.8em;">✏️</button>\n          </div>\n          <strong>Coordinates:</strong> \n          <div style="display: flex; gap: 0.5em; align-items: center;">\n            <span id="bm-E">${t.coords}</span>\n            <button id="bm-Q" class="bm-q" style="width: 25px; height: 25px; background: #2196F3; font-size: 0.8em;">✏️</button>\n          </div>\n          <strong>Status:</strong> <span style="color: ${t.enabled?"#4CAF50":"#f44336"};">${t.enabled?"Enabled":"Disabled"}</span>\n          <strong>Template ID:</strong> <span>${t.key}</span>\n        </div>\n        <div id="bm-R" style="display: none; margin-top: 1em; padding: 1em; background: rgba(0,0,0,0.3); border-radius: 4px;">\n          <div style="margin-bottom: 0.5em; font-weight: bold;">Edit Template Name:</div>\n          <div style="display: flex; gap: 0.5em; align-items: center;">\n            <input type="text" id="bm-r-input" value="${t.name}" style="flex: 1; padding: 0.3em; background: #333; border: 1px solid #666; color: white; border-radius: 3px;">\n            <button id="bm-r-save" style="padding: 0.3em 0.6em; background: #4CAF50; border: none; color: white; border-radius: 3px; cursor: pointer;">Save</button>\n            <button id="bm-r-cancel" style="padding: 0.3em 0.6em; background: #666; border: none; color: white; border-radius: 3px; cursor: pointer;">Cancel</button>\n          </div>\n        </div>\n        <div id="bm-I" style="display: none; margin-top: 1em; padding: 1em; background: rgba(0,0,0,0.3); border-radius: 4px;">\n          <div style="margin-bottom: 0.5em; font-weight: bold;">Edit Coordinates:</div>\n          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5em; margin-bottom: 0.5em;">\n            <input type="number" id="bm-1h" placeholder="Tile X" min="0" max="2047" style="padding: 0.3em; background: #333; border: 1px solid #666; color: white; border-radius: 3px;">\n            <input type="number" id="bm-1i" placeholder="Tile Y" min="0" max="2047" style="padding: 0.3em; background: #333; border: 1px solid #666; color: white; border-radius: 3px;">\n            <input type="number" id="bm-1e" placeholder="Pixel X" min="0" max="999" style="padding: 0.3em; background: #333; border: 1px solid #666; color: white; border-radius: 3px;">\n            <input type="number" id="bm-1f" placeholder="Pixel Y" min="0" max="999" style="padding: 0.3em; background: #333; border: 1px solid #666; color: white; border-radius: 3px;">\n          </div>\n          <div style="display: flex; gap: 0.5em;">\n            <button id="bm-1k" style="flex: 1; padding: 0.5em; background: #4CAF50; border: none; color: white; border-radius: 3px; cursor: pointer;">Save</button>\n            <button id="bm-1g" style="flex: 1; padding: 0.5em; background: #666; border: none; color: white; border-radius: 3px; cursor: pointer;">Cancel</button>\n          </div>\n        </div>\n      </div>\n\n      <div class="info-section">\n        <h4>📊 Statistics</h4>\n        <div class="info-stats">\n          <div class="stat-item">\n            <div class="stat-value">${(new Intl.NumberFormat).format(t.pixelCount)}</div>\n            <div class="stat-label">Total Pixels</div>\n          </div>\n          <div class="stat-item">\n            <div class="stat-value" id="bm-1q">Loading...</div>\n            <div class="stat-label">Tiles Used</div>\n          </div>\n        </div>\n      </div>\n\n      <div class="info-section">\n        <h4>🎨 Template Preview</h4>\n        <div class="info-preview">\n          <div id="bm-B">Generating preview...</div>\n        </div>\n      </div>\n\n      <div class="info-section">\n        <h4>🌈 Color Analysis</h4>\n        <div id="bm-1l">Analyzing colors...</div>\n      </div>\n    `,e.style.display="block",document.getElementById("bm-1o").onclick=()=>{e.style.display="none"};const o=document.getElementById("bm-Q"),i=document.getElementById("bm-I"),a=document.getElementById("bm-E"),s={Xt:document.getElementById("bm-1h"),Yt:document.getElementById("bm-1i"),Gt:document.getElementById("bm-1e"),Ht:document.getElementById("bm-1f")},r=t.coords.split(",").map(t=>parseInt(t.trim()));o.onclick=()=>{s.Xt.value=r[0]||"",s.Yt.value=r[1]||"",s.Gt.value=r[2]||"",s.Ht.value=r[3]||"",i.style.display="block",o.style.display="none"},document.getElementById("bm-1g").onclick=()=>{i.style.display="none",o.style.display="inline-block"},document.getElementById("bm-1k").onclick=async()=>{try{const e=[parseInt(s.Xt.value),parseInt(s.Yt.value),parseInt(s.Gt.value),parseInt(s.Ht.value)];if(e.some(t=>isNaN(t)||t<0))throw new Error("All coordinates must be non-negative numbers");if(e[0]>2047||e[1]>2047)throw new Error("Tile coordinates must be between 0-2047");if(e[2]>999||e[3]>999)throw new Error("Pixel coordinates must be between 0-999");const n=await w.Mt(t.key,e),r=e.join(", ");a.textContent=r,t.coords=r,i.style.display="none",o.style.display="inline-block",window.refreshTemplateList&&refreshTemplateList(),f.P(n)}catch(t){alert(`Failed to update coordinates: ${t.message}`),console.error("Coordinate update error:",t)}};const l=document.getElementById("bm-13"),m=document.getElementById("bm-R"),c=document.getElementById("bm-M"),d=document.getElementById("bm-r-input");if(l.onclick=()=>{d.value=t.name,m.style.display="block",l.style.display="none"},document.getElementById("bm-r-cancel").onclick=()=>{m.style.display="none",l.style.display="inline-block"},document.getElementById("bm-r-save").onclick=async()=>{try{const e=d.value.trim();if(!e)throw new Error("Template name cannot be empty");if(e.length>100)throw new Error("Template name must be 100 characters or less");await w.Dt(t.key,e),c.textContent=e,t.name=e,m.style.display="none",l.style.display="inline-block",window.refreshTemplateList&&refreshTemplateList(),f.P(`Template renamed to "${e}"`)}catch(t){alert(`Failed to update name: ${t.message}`),console.error("Name update error:",t)}},n&&n.G){const t=Object.keys(n.G).length;document.getElementById("bm-1q").textContent=t;try{const{Rt:t,Jt:e}=await async function(t){if(!t.G)return{Rt:null,Jt:[]};const e=document.createElement("canvas"),n=e.getContext("2d"),o=new Map;let i=0,a=1/0,s=1/0,r=-1/0,l=-1/0;for(const[e,n]of Object.entries(t.G)){const[t,m,c,d]=e.split(",").map(Number);a=Math.min(a,parseInt(c)),s=Math.min(s,parseInt(d)),r=Math.max(r,parseInt(c)+n.width/3),l=Math.max(l,parseInt(d)+n.height/3);const b=document.createElement("canvas"),p=b.getContext("2d");b.width=n.width,b.height=n.height,p.drawImage(n,0,0);const u=p.getImageData(0,0,n.width,n.height).data;for(let t=1;t<n.height;t+=3)for(let e=1;e<n.width;e+=3){const a=4*(t*n.width+e);if(u[a+3]>0){const t=u[a],e=u[a+1],n=u[a+2],s=`#${t.toString(16).padStart(2,"0")}${e.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`;o.set(s,(o.get(s)||0)+1),i++}}}let m=null;if(a!==1/0){const o=Math.min(400,r-a),i=Math.min(300,l-s),c=Math.min(o/(r-a),i/(l-s));e.width=(r-a)*c,e.height=(l-s)*c,n.imageSmoothingEnabled=!1;for(const[e,o]of Object.entries(t.G)){const[t,i,r,l]=e.split(",").map(Number),m=(parseInt(r)-a)*c,d=(parseInt(l)-s)*c,b=o.width/3*c,p=o.height/3*c;n.drawImage(o,m,d,b,p)}m=e}return{Rt:m,Jt:Array.from(o.entries()).map(([t,e])=>({Vt:t,count:e,Ut:(e/i*100).toFixed(1)})).sort((t,e)=>e.count-t.count).slice(0,20)}}(n),o=document.getElementById("bm-B");t?(o.innerHTML="",o.appendChild(t)):o.textContent="Preview not available";const i=document.getElementById("bm-1l");if(e&&e.length>0){const t=e.reduce((t,e)=>t+e.count,0);i.innerHTML=`\n            <div style="margin-bottom: 0.5em; font-size: 0.9em;">\n              <strong>Unique Colors:</strong> ${e.length} | \n              <strong>Analyzed Pixels:</strong> ${(new Intl.NumberFormat).format(t)}\n            </div>\n            <div class="color-grid">\n              ${e.map(t=>`\n                <div class="color-item">\n                  <div class="color-swatch" style="background-color: ${t.Vt};"></div>\n                  <div class="color-info">\n                    <div style="font-weight: bold;">${t.Vt}</div>\n                    <div>${t.count} px (${t.Ut}%)</div>\n                  </div>\n                </div>\n              `).join("")}\n            </div>\n          `}else i.textContent="No color data available"}catch(t){console.error("Failed to analyze template:",t),document.getElementById("bm-B").textContent="Analysis failed",document.getElementById("bm-1l").textContent="Color analysis failed"}}},f.F("#bm-n","#bm-i"),v.Pt(f),new MutationObserver((t,e)=>{const n=document.querySelector("#color-1");if(!n)return;let o=document.querySelector("#bm-g");if(!o){o=document.createElement("button"),o.id="bm-g",o.textContent="Move ↑",o.className="btn btn-soft",o.onclick=function(){const t=this.parentNode.parentNode.parentNode.parentNode,e="Move ↑"==this.textContent;t.parentNode.className=t.parentNode.className.replace(e?"bottom":"top",e?"top":"bottom"),t.style.borderTopLeftRadius=e?"0px":"var(--radius-box)",t.style.borderTopRightRadius=e?"0px":"var(--radius-box)",t.style.borderBottomLeftRadius=e?"var(--radius-box)":"0px",t.style.borderBottomRightRadius=e?"var(--radius-box)":"0px",this.textContent=e?"Move ↓":"Move ↑"};const t=n.parentNode.parentNode.parentNode.parentNode.querySelector("h2");t.parentNode?.appendChild(o)}}).observe(document.body,{childList:!0,subtree:!0}),document.addEventListener("keydown",t=>{if("INPUT"!==document.activeElement.tagName&&"TEXTAREA"!==document.activeElement.tagName){if(t.ctrlKey&&"t"===t.key){t.preventDefault();const e=document.querySelector("#bm-P"),n=document.querySelector("#bm-16");if(e){const t="none"!==e.style.display;e.style.display=t?"none":"block",t?n&&(n.style.backgroundColor="",n.style.fontWeight=""):(window.refreshTemplateList&&refreshTemplateList(),n&&(n.style.backgroundColor="#2e97ff",n.style.fontWeight="bold"))}}t.ctrlKey&&t.shiftKey&&"E"===t.key&&(t.preventDefault(),w&&w.Ot&&(w.Ot(!0),window.refreshTemplateList&&refreshTemplateList(),f.P("All templates enabled via keyboard shortcut!"))),t.ctrlKey&&t.shiftKey&&"D"===t.key&&(t.preventDefault(),w&&w.Ot&&(w.Ot(!1),window.refreshTemplateList&&refreshTemplateList(),f.P("All templates disabled via keyboard shortcut!")))}}),function(...t){(0,console.log)(...t)}(`%c${u}%c (${h}) userscript has loaded!`,"color: cornflowerblue;","")})();