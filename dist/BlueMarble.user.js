// ==UserScript==
// @name         Blue Peanits
// @namespace    https://github.com/MopigamesYT/
// @version      0.83.0
// @description  A userscript to automate and/or enhance the user experience on Wplace.live. Make sure to comply with the site's Terms of Service, and rules! This script is not affiliated with Wplace.live in any way, use at your own risk. This script is not affiliated with TamperMonkey. The author of this userscript is not responsible for any damages, issues, loss of data, or punishment that may occur as a result of using this script. This script is provided "as is" under the MPL-2.0 license. The "Blue Marble" icon is licensed under CC0 1.0 Universal (CC0 1.0) Public Domain Dedication. The image is owned by NASA.
// @author       MopigamesYT
// @license      MPL-2.0
// @supportURL   https://discord.gg/tpeBPy46hf
// @homepageURL  https://github.com/MopigamesYT/BluePeanits
// @icon         https://raw.githubusercontent.com/MopigamesYT/BluePeanits/22adac281cc822bcb3064983437a92c76fae9f79/dist/assets/Favicon.png
// @updateURL    https://raw.githubusercontent.com/MopigamesYT/BluePeanits/main/dist/BlueMarble.user.js
// @downloadURL  https://raw.githubusercontent.com/MopigamesYT/BluePeanits/main/dist/BlueMarble.user.js
// @run-at       document-start
// @match        *://*.wplace.live/*
// @grant        GM_addStyle
// @grant        GM.setValue
// @grant        GM_getValue
// ==/UserScript==

// Wplace  --> https://wplace.live
// License --> https://www.mozilla.org/en-US/MPL/2.0/

(()=>{var t,e,n=t=>{throw TypeError(t)},o=(t,e,o)=>e.has(t)?n("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,o),i=(t,e,o)=>(((t,e)=>{e.has(t)||n("Cannot access private method")})(t,e),o),a=class{constructor(e,n){o(this,t),this.name=e,this.version=n,this.t=null,this.o="bm-C",this.i=null,this.l=null,this.m=[]}p(t){this.t=t}u(){return this.m.length>0&&(this.l=this.m.pop()),this}h(t){t?.appendChild(this.i),this.i=null,this.l=null,this.m=[]}v(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"div",{},n)),this}k(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"p",{},n)),this}T(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"small",{},n)),this}$(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"img",{},n)),this}C(n,o={},a=()=>{}){return a(this,i(this,t,e).call(this,"h"+n,{},o)),this}M(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"hr",{},n)),this}I(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"br",{},n)),this}N(n={},o=()=>{}){const a=i(this,t,e).call(this,"label",{textContent:n.textContent??""});delete n.textContent;const r=i(this,t,e).call(this,"input",{type:"checkbox"},n);return a.insertBefore(r,a.firstChild),this.u(),o(this,a,r),this}A(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"button",{},n)),this}D(n={},o=()=>{}){const a=n.title??n.textContent??"Help: No info";delete n.textContent,n.title=`Help: ${a}`;const r={textContent:"?",className:"bm-17",onclick:()=>{this.S(this.o,a)}};return o(this,i(this,t,e).call(this,"button",r,n)),this}O(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"input",{},n)),this}j(n={},o=()=>{}){const a=n.textContent??"";delete n.textContent;const r=i(this,t,e).call(this,"div"),s=i(this,t,e).call(this,"input",{type:"file",style:"display: none !important; visibility: hidden !important; position: absolute !important; left: -9999px !important; width: 0 !important; height: 0 !important; opacity: 0 !important;"},n);this.u();const l=i(this,t,e).call(this,"button",{textContent:a});return this.u(),this.u(),s.setAttribute("tabindex","-1"),s.setAttribute("aria-hidden","true"),l.addEventListener("click",()=>{s.click()}),s.addEventListener("change",()=>{l.style.maxWidth=`${l.offsetWidth}px`,s.files.length>0?l.textContent=s.files[0].name:l.textContent=a}),o(this,r,s,l),this}L(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"textarea",{},n)),this}S(t,e,n=!1){const o=document.getElementById(t.replace(/^#/,""));o&&(o instanceof HTMLInputElement?o.value=e:n?o.textContent=e:o.innerHTML=e)}B(t,e){let n,o=!1,i=0,a=null,r=0,s=0,l=0,m=0;if(t=document.querySelector("#"==t?.[0]?t:"#"+t),e=document.querySelector("#"==e?.[0]?e:"#"+e),!t||!e)return void this.F(`Can not drag! ${t?"":"moveMe"} ${t||e?"":"and "}${e?"":"iMoveThings "}was not found!`);const c=()=>{if(o){const e=Math.abs(r-l),n=Math.abs(s-m);(e>.5||n>.5)&&(r=l,s=m,t.style.transform=`translate(${r}px, ${s}px)`,t.style.left="0px",t.style.top="0px",t.style.right=""),a=requestAnimationFrame(c)}};let d=null;const b=(b,p)=>{o=!0,d=t.getBoundingClientRect(),n=b-d.left,i=p-d.top;const u=window.getComputedStyle(t).transform;if(u&&"none"!==u){const t=new DOMMatrix(u);r=t.m41,s=t.m42}else r=d.left,s=d.top;l=r,m=s,document.body.style.userSelect="none",e.classList.add("dragging"),a&&cancelAnimationFrame(a),c()},p=()=>{o=!1,a&&(cancelAnimationFrame(a),a=null),document.body.style.userSelect="",e.classList.remove("dragging")};e.addEventListener("mousedown",function(t){t.preventDefault(),b(t.clientX,t.clientY)}),e.addEventListener("touchstart",function(t){const e=t?.touches?.[0];e&&(b(e.clientX,e.clientY),t.preventDefault())},{passive:!1}),document.addEventListener("mousemove",function(t){o&&d&&(l=t.clientX-n,m=t.clientY-i)},{passive:!0}),document.addEventListener("touchmove",function(t){if(o&&d){const e=t?.touches?.[0];if(!e)return;l=e.clientX-n,m=e.clientY-i,t.preventDefault()}},{passive:!1}),document.addEventListener("mouseup",p),document.addEventListener("touchend",p),document.addEventListener("touchcancel",p)}P(t){(0,console.info)(`${this.name}: ${t}`),this.S(this.o,"Status: "+t,!0)}F(t){(0,console.error)(`${this.name}: ${t}`),this.S(this.o,"Error: "+t,!0)}};function r(t,e){if(0===t)return e[0];let n="";const o=e.length;for(;t>0;)n=e[t%o]+n,t=Math.floor(t/o);return n}function s(t){let e="";for(let n=0;n<t.length;n++)e+=String.fromCharCode(t[n]);return btoa(e)}function l(t){const e=atob(t),n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return n}t=new WeakSet,e=function(t,e={},n={}){const o=document.createElement(t);this.i?(this.l?.appendChild(o),this.m.push(this.l),this.l=o):(this.i=o,this.l=o);for(const[t,n]of Object.entries(e))o[t]=n;for(const[t,e]of Object.entries(n))o[t]=e;return o};var m,c,d,b,p=class{constructor({displayName:t="My template",H:e=0,V:n="",url:o="",file:i=null,coords:a=null,X:r=null,Y:s=1e3,enabled:l=!0}={}){this.displayName=t,this.H=e,this.V=n,this.url=o,this.file=i,this.coords=a,this.X=r,this.Y=s,this.pixelCount=0,this.enabled=l}async R(){const t=await createImageBitmap(this.file),e=t.width,n=t.height,o=e*n;this.pixelCount=o;const i={},a={},r=new OffscreenCanvas(this.Y,this.Y),l=r.getContext("2d",{U:!0});for(let o=this.coords[3];o<n+this.coords[3];){const m=Math.min(this.Y-o%this.Y,n-(o-this.coords[3]));for(let n=this.coords[2];n<e+this.coords[2];){const c=Math.min(this.Y-n%this.Y,e-(n-this.coords[2])),d=3*c,b=3*m;r.width=d,r.height=b,l.imageSmoothingEnabled=!1,l.clearRect(0,0,d,b),l.drawImage(t,n-this.coords[2],o-this.coords[3],c,m,0,0,3*c,3*m);const p=l.getImageData(0,0,d,b);for(let t=0;t<b;t++)for(let e=0;e<d;e++){const n=4*(t*d+e);222===p.data[n]&&250===p.data[n+1]&&206===p.data[n+2]?(e+t)%2==0?(p.data[n]=0,p.data[n+1]=0,p.data[n+2]=0,p.data[n+3]=32):p.data[n+3]=0:e%3==1&&t%3==1||(p.data[n+3]=0)}l.putImageData(p,0,0);const u=`${(this.coords[0]+Math.floor(n/1e3)).toString().padStart(4,"0")},${(this.coords[1]+Math.floor(o/1e3)).toString().padStart(4,"0")},${(n%1e3).toString().padStart(3,"0")},${(o%1e3).toString().padStart(3,"0")}`;i[u]=await createImageBitmap(r);const h=await r.convertToBlob(),g=await h.arrayBuffer(),f=Array.from(new Uint8Array(g));a[u]=s(f),n+=c}o+=m}return{q:i,_:a}}};m=new WeakSet,c=async function(){GM.setValue("bmTemplates",JSON.stringify(this.G));try{localStorage.setItem("BlueMarbleTemplates",JSON.stringify(this.G))}catch(t){}},d=async function(t){const e=t.templates;if(Object.keys(e).length>0)for(const t in e){const n=t,o=e[t];if(e.hasOwnProperty(t)){const t=n.split(" "),e=Number(t?.[0]),a=t?.[1]||"0",r=o.name||`Template ${e||""}`,s=void 0===o.enabled||o.enabled,c=o.tiles,d={};for(const t in c)if(c.hasOwnProperty(t)){const e=l(c[t]),n=new Blob([e],{type:"image/png"}),o=await createImageBitmap(n);d[t]=o}const u=new p({displayName:r,H:e||this.J?.length||0,V:a||"",enabled:s});if(u.X=d,"number"==typeof o.pixelCount&&o.pixelCount>=0)u.pixelCount=o.pixelCount;else try{u.pixelCount=await i(this,m,b).call(this,d),o.pixelCount=u.pixelCount}catch(t){const e=Object.keys(d).length||1;u.pixelCount=500*e,o.pixelCount=u.pixelCount}this.J.push(u)}}},b=async function(t){let e=0;const n="undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas"),o=n.getContext("2d",{U:!0});for(const i of Object.keys(t)){const a=t[i];if(!a)continue;n.width=a.width,n.height=a.height,o.clearRect(0,0,a.width,a.height),o.drawImage(a,0,0);const{data:r,width:s,height:l}=o.getImageData(0,0,a.width,a.height);for(let t=1;t<l;t+=3)for(let n=1;n<s;n+=3)r[4*(t*s+n)+3]>0&&e++}return e};var u=GM_info.script.name.toString(),h=GM_info.script.version.toString();!function(t){const e=document.createElement("script");e.setAttribute("bm-18",u),e.setAttribute("bm-15","color: cornflowerblue;"),e.textContent=`(${t})();`,document.documentElement?.appendChild(e),e.remove()}(()=>{const t=document.currentScript,e=t?.getAttribute("bm-18")||"Blue Peanits",n=t?.getAttribute("bm-15")||"",o=new Map;window.addEventListener("message",t=>{const{source:i,endpoint:a,blobID:r,blobData:s,blink:l}=t.data;if(Date.now(),"blue-marble"==i&&r&&s&&!a){const t=o.get(r);"function"==typeof t?t(s):function(...t){(0,console.warn)(...t)}(`%c${e}%c: Attempted to retrieve a blob (%s) from queue, but the blobID was not a function! Skipping...`,n,"",r),o.delete(r)}});const i=window.fetch;window.fetch=async function(...t){const e=await i.apply(this,t),n=e.clone(),a=(t[0]instanceof Request?t[0]?.url:t[0])||"ignore",r=n.headers.get("content-type")||"";if(r.includes("application/json"))n.json().then(t=>{window.postMessage({source:"blue-marble",endpoint:a,jsonData:t},"*")}).catch(t=>{});else if(r.includes("image/")&&!a.includes("openfreemap")&&!a.includes("maps")){const t=Date.now(),e=await n.blob();return new Promise(i=>{const r=crypto.randomUUID();o.set(r,t=>{i(new Response(t,{headers:n.headers,status:n.status,statusText:n.statusText}))}),window.postMessage({source:"blue-marble",endpoint:a,blobID:r,blobData:e,blink:t})}).catch(t=>{Date.now()})}return e}}),GM_addStyle('#bm-14{position:fixed;background-color:rgba(21,48,99,0.9);color:white;padding:10px;border-radius:8px;z-index:9000;transition:all 0.3s ease,transform 0s;max-width:300px;width:auto;will-change:transform;backface-visibility:hidden;-webkit-backface-visibility:hidden;transform-style:preserve-3d;-webkit-transform-style:preserve-3d}#bm-j,#bm-14 hr,#bm-b,#bm-1{transition:opacity 0.2s ease,height 0.2s ease}div#bm-14{font-family:\'Roboto Mono\',\'Courier New\',\'Monaco\',\'DejaVu Sans Mono\',monospace,\'Arial\';letter-spacing:0.05em}#bm-_{margin-bottom:0.5em;background:url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="5" height="5"><circle cx="3" cy="3" r="1.5" fill="CornflowerBlue" /></svg>\') repeat;cursor:grab;width:100%;height:1em;transition:margin-bottom 0.2s ease}#bm-_.dragging{cursor:grabbing;pointer-events:auto}#bm-14:has(#bm-_.dragging){pointer-events:none;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}#bm-t{margin-bottom:0.5em}#bm-t[style*="text-align: center"]{display:flex;flex-direction:column;align-items:center;justify-content:center}#bm-14[style*="padding: 5px"]{width:auto!important;max-width:300px;min-width:200px}#bm-14 img{display:inline-block;height:2.5em;margin-right:1ch;vertical-align:middle;transition:opacity 0.2s ease}#bm-t[style*="text-align: center"] img{margin-right:0;margin-left:0;display:block;margin:0 auto}#bm-14 h1{display:inline-block;font-size:x-large;font-weight:bold;vertical-align:middle}#bm-b input[type="checkbox"]{vertical-align:middle;margin-right:0.5ch}#bm-b label{margin-right:0.5ch}.bm-17{border:white 1px solid;height:1.5em;width:1.5em;margin-top:2px;text-align:center;line-height:1em;padding:0!important}#bm-D{vertical-align:middle}#bm-D svg{width:50%;margin:0 auto;fill:#111}#bm-k{display:flex;gap:0.5ch;align-items:center}#bm-c{background-color:#666;font-size:0.7em;padding:0.1em 0.3em;border-radius:0.5em;transition:background-color 0.2s ease}#bm-c.active{background-color:#4CAF50}#bm-c:hover{background-color:#777}#bm-c.active:hover{background-color:#45a049}#bm-f{background-color:#444!important;border:1px solid #666!important;transition:all 0.2s ease}#bm-f.active{background-color:#1a1a1a!important;border-color:#888!important}#bm-f:hover{background-color:#555!important}#bm-f.active:hover{background-color:#333!important}div:has(> #bm-o){display:flex;gap:0.5ch}#bm-p svg,#bm-q svg{height:1em;margin:0 auto;margin-top:2px;text-align:center;line-height:1em;vertical-align:bottom}#bm-u input[type="number"]{appearance:auto;-moz-appearance:textfield;width:5.5ch;margin-left:1ch;background-color:rgba(0,0,0,0.2);padding:0 0.5ch;font-size:small}#bm-u input[type="number"]::-webkit-outer-spin-button,#bm-u input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}#bm-0{display:grid;grid-template-columns:1fr 1fr;gap:0.5em;align-items:center}#bm-E{grid-column:1/-1;margin-bottom:0.5em}div:has(> #bm-8) > button{width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}#bm-8,input[type="file"][id*="template"]{display:none!important;visibility:hidden!important;position:absolute!important;left:-9999px!important;top:-9999px!important;width:0!important;height:0!important;opacity:0!important;z-index:-9999!important;pointer-events:none!important}#bm-C{font-size:small;background-color:rgba(0,0,0,0.2);padding:0 0.5ch;height:3.75em;width:100%}#bm-1{display:flex;justify-content:space-between}#bm-14 small{font-size:x-small;color:lightgray}#bm-j,#bm-b,#bm-u,#bm-0,div:has(> #bm-8),#bm-C{margin-top:0.5em}#bm-14 button{background-color:#144eb9;border-radius:1em;padding:0 0.75ch}#bm-14 button:hover,#bm-14 button:focus-visible{background-color:#1061e5}#bm-14 button:active,#bm-14 button:disabled{background-color:#2e97ff}#bm-14 button:disabled{text-decoration:line-through}#bm-l{position:fixed;background-color:rgba(21,48,99,0.95);color:white;padding:15px;border-radius:8px;z-index:9001;max-width:450px;min-width:400px;max-height:80vh;overflow:hidden;font-family:\'Roboto Mono\',\'Courier New\',\'Monaco\',\'DejaVu Sans Mono\',monospace,\'Arial\';letter-spacing:0.05em;box-shadow:0 4px 20px rgba(0,0,0,0.3);transition:all 0.3s ease,transform 0s;will-change:transform;backface-visibility:hidden;-webkit-backface-visibility:hidden;transform-style:preserve-3d;-webkit-transform-style:preserve-3d}#bm-F{margin-bottom:0.5em;background:url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="5" height="5"><circle cx="3" cy="3" r="1.5" fill="CornflowerBlue" /></svg>\') repeat;cursor:grab;width:100%;height:1em}#bm-F.dragging{cursor:grabbing}#bm-g{display:flex;gap:0.5em;margin-bottom:1em}#bm-g button{flex:1;background-color:#144eb9;border-radius:1em;padding:0.5em;font-size:0.9em}#bm-g button:hover{background-color:#1061e5}#bm-G{max-height:300px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#144eb9 rgba(0,0,0,0.2)}#bm-G::-webkit-scrollbar{width:8px}#bm-G::-webkit-scrollbar-track{background:rgba(0,0,0,0.2);border-radius:4px}#bm-G::-webkit-scrollbar-thumb{background:#144eb9;border-radius:4px}#bm-G::-webkit-scrollbar-thumb:hover{background:#1061e5}.bm-H{transition:all 0.2s ease}.bm-H:hover{background-color:rgba(0,0,0,0.35)!important;transform:translateX(2px)}#bm-v{font-size:0.9em;color:#ccc}#bm-v p{margin:0.25em 0}#bm-w{background-color:#d32f2f!important;color:white;border:none;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-weight:bold}#bm-w:hover{background-color:#f44336!important}body.bm-V{background-color:#1a1a1a!important;color:#e0e0e0!important;color-scheme:dark!important;--color-base-100:rgb(26,26,26)!important;--color-base-200:oklch(15% .011 259.822)!important;--color-base-300:oklch(20% .016 262.751)!important;--color-base-content:oklch(85% .053 255.824)!important;--color-primary:oklch(65% .255 257.57)!important;--color-primary-content:oklch(15% .051 257.57)!important;--color-secondary:oklch(50% .161 282.339)!important;--color-secondary-content:oklch(20% .032 282.339)!important;--color-accent:oklch(70% .191 335.171)!important;--color-accent-content:oklch(15% .038 335.171)!important;--color-neutral:oklch(80% .063 257.651)!important;--color-neutral-content:oklch(25% .012 257.651)!important;--color-info:oklch(70% .085 214.515)!important;--color-info-content:oklch(15% .017 214.515)!important;--color-success:oklch(65% .077 197.823)!important;--color-success-content:oklch(15% .015 197.823)!important;--color-warning:oklch(75% .045 71.47)!important;--color-warning-content:oklch(15% .009 71.47)!important;--color-error:oklch(65% .11 20.076)!important;--color-error-content:oklch(15% .022 20.076)!important}body.bm-V *{color:#e0e0e0!important}body.bm-V .navbar,body.bm-V .navbar-brand,body.bm-V .nav-link{background-color:#2d2d2d!important;border-color:#444!important}body.bm-V .btn{background-color:#444!important;border-color:#666!important;color:#e0e0e0!important}body.bm-V .btn:hover{background-color:#555!important}body.bm-V .card,body.bm-V .modal-content{background-color:#2d2d2d!important;border-color:#444!important}body.bm-V input,body.bm-V select,body.bm-V textarea{background-color:#333!important;border-color:#555!important;color:#e0e0e0!important}body.bm-V .bg-light{background-color:#333!important}body.bm-V .text-dark{color:#e0e0e0!important}body.bm-V .border{border-color:#444!important}body.bm-V .container,body.bm-V .row,body.bm-V .col{background-color:transparent!important}#bm-I{position:fixed;background-color:rgba(21,48,99,0.98);color:white;padding:20px;border-radius:10px;z-index:9002;max-width:600px;min-width:500px;max-height:85vh;overflow-y:auto;font-family:\'Roboto Mono\',\'Courier New\',\'Monaco\',\'DejaVu Sans Mono\',monospace,\'Arial\';letter-spacing:0.05em;box-shadow:0 6px 30px rgba(0,0,0,0.4);transition:all 0.3s ease}#bm-I .info-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1em;border-bottom:1px solid rgba(255,255,255,0.3);padding-bottom:0.5em}#bm-I .info-preview{text-align:center;margin:1em 0;background:rgba(0,0,0,0.3);border-radius:6px;padding:1em}#bm-I .info-preview canvas{max-width:100%;max-height:200px;border:1px solid #666;border-radius:4px;image-rendering:pixelated}#bm-I .info-section{margin:1em 0;padding:0.75em;background:rgba(0,0,0,0.2);border-radius:6px}#bm-I .info-section h4{margin:0 0 0.5em 0;color:#87CEEB;font-size:1em}#bm-I .color-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:0.5em;margin-top:0.5em}#bm-I .color-item{display:flex;align-items:center;gap:0.5em;padding:0.3em;background:rgba(255,255,255,0.1);border-radius:3px}#bm-I .color-swatch{width:20px;height:20px;border-radius:3px;border:1px solid #666;flex-shrink:0}#bm-I .color-info{font-size:0.8em;flex:1;min-width:0}#bm-I .info-stats{display:grid;grid-template-columns:1fr 1fr;gap:1em}#bm-I .stat-item{text-align:center;padding:0.5em;background:rgba(255,255,255,0.1);border-radius:4px}#bm-I .stat-value{font-size:1.2em;font-weight:bold;color:#87CEEB}#bm-I .stat-label{font-size:0.8em;opacity:0.8}#bm-I input[type="number"]{appearance:textfield;-moz-appearance:textfield}#bm-I input[type="number"]::-webkit-outer-spin-button,#bm-I input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}#bm-I button:hover{opacity:0.8;transform:translateY(-1px)}');var g=document.createElement("link");g.href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap",g.rel="preload",g.as="style",g.onload=function(){this.onload=null,this.rel="stylesheet"},document.head?.appendChild(g),new class{constructor(){this.W=null,this.Z=null,this.K="#bm-x"}tt(t){return this.Z=t,this.W=new MutationObserver(t=>{for(const e of t)for(const t of e.addedNodes)t instanceof HTMLElement&&t.matches?.(this.K)}),this}et(){return this.W}observe(t,e=!1,n=!1){t.observe(this.Z,{childList:e,subtree:n})}};var f=new a(u,h),y=new a(u,h),w=new class{constructor(t,e,n){o(this,m),this.name=t,this.version=e,this.i=n,this.nt="1.0.0",this.ot=null,this.it="!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~",this.Y=1e3,this.rt=3,this.st=!1,this.lt=null,this.ct=null,this.dt="bm-16",this.bt="div#map canvas.maplibregl-canvas",this.ut=null,this.ht="",this.J=[],this.G=null,this.gt=!0}ft(){if(document.body.contains(this.lt))return this.lt;document.getElementById(this.dt)?.remove();const t=document.querySelector(this.bt),e=document.createElement("canvas");return e.id=this.dt,e.className="maplibregl-canvas",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.height=t?.clientHeight*(window.devicePixelRatio||1)+"px",e.style.width=t?.clientWidth*(window.devicePixelRatio||1)+"px",e.height=t?.clientHeight*(window.devicePixelRatio||1),e.width=t?.clientWidth*(window.devicePixelRatio||1),e.style.zIndex="8999",e.style.pointerEvents="none",t?.parentElement?.appendChild(e),this.lt=e,window.addEventListener("move",this.yt),window.addEventListener("zoom",this.wt),window.addEventListener("resize",this.vt),this.lt}async xt(){return{whoami:this.name.replace(" ",""),scriptVersion:this.version,schemaVersion:this.nt,templates:{}}}async kt(t,e,n){this.G||(this.G=await this.xt()),this.i.P(`Creating template at ${n.join(", ")}...`);const o=new p({displayName:e,H:Object.keys(this.G.templates).length||0,V:r(this.ot||0,this.it),file:t,coords:n}),{q:a,_:s}=await o.R(this.Y);o.X=a,this.G.templates[`${o.H} ${o.V}`]={name:o.displayName,coords:n.join(", "),enabled:!0,tiles:s,pixelCount:o.pixelCount},this.J.push(o);const l=(new Intl.NumberFormat).format(o.pixelCount);this.i.P(`Template created at ${n.join(", ")}! Total pixels: ${l}`),await i(this,m,c).call(this)}async Tt(t){this.G||(this.G=await this.xt()),this.G.templates[t]&&delete this.G.templates[t];const[e,n]=t.split(" ");this.J=this.J.filter(t=>!(t.H==Number(e)&&t.V===n)),await i(this,m,c).call(this)}async $t(t,e){this.G||(this.G=await this.xt()),this.G.templates[t]&&(this.G.templates[t].enabled=e);const[n,o]=t.split(" "),a=this.J.find(t=>t.H==Number(n)&&t.V===o);a&&(a.enabled=e),await i(this,m,c).call(this)}async Ct(t,e){if(this.G||(this.G=await this.xt()),!Array.isArray(e)||4!==e.length)throw new Error("Coordinates must be an array of 4 numbers [tileX, tileY, pixelX, pixelY]");const[n,o,a,r]=e.map(Number);if(![n,o,a,r].every(t=>!isNaN(t)&&isFinite(t)))throw new Error("All coordinates must be valid numbers");this.G.templates[t]&&(this.G.templates[t].coords=e.join(", "));const[s,l]=t.split(" "),d=this.J.find(t=>t.H==Number(s)&&t.V===l);return d&&(d.coords=e),await i(this,m,c).call(this),`Template coordinates updated to: ${e.join(", ")}`}Mt(){return this.G&&this.G.templates?Object.entries(this.G.templates).map(([t,e])=>({key:t,name:e.name,coords:e.coords,enabled:e.enabled,pixelCount:this.J.find(e=>`${e.H} ${e.V}`===t)?.pixelCount||e.pixelCount||0})):[]}async It(t,e){if(!this.gt)return t;const n=this.Y*this.rt;e=e[0].toString().padStart(4,"0")+","+e[1].toString().padStart(4,"0");const o=this.J;o.sort((t,e)=>t.H-e.H);const i=o.filter(t=>t.enabled).map(t=>{const n=Object.keys(t.X).filter(t=>t.startsWith(e));if(0===n.length)return null;const o=n.map(e=>{const n=e.split(",");return{Nt:t.X[e],zt:[n[0],n[1]],At:[n[2],n[3]]}});return o?.[0]}).filter(Boolean),a=i?.length||0;if(a>0){const t=o.filter(t=>Object.keys(t.X).filter(t=>t.startsWith(e)).length>0&&t.enabled).reduce((t,e)=>t+(e.pixelCount||0),0),n=(new Intl.NumberFormat).format(t);this.i.P(`Displaying ${a} template${1==a?"":"s"}.\nTotal pixels: ${n}`)}else this.i.P(`Displaying ${a} templates.`);const r=await createImageBitmap(t),s=new OffscreenCanvas(n,n),l=s.getContext("2d");l.imageSmoothingEnabled=!1,l.beginPath(),l.rect(0,0,n,n),l.clip(),l.clearRect(0,0,n,n),l.drawImage(r,0,0,n,n);for(const t of i)l.drawImage(t.Nt,Number(t.At[0])*this.rt,Number(t.At[1])*this.rt);return await s.convertToBlob({type:"image/png"})}async Dt(t){const e=(this.name||"").replace(/\s+/g,""),n=["BlueMarble","BluePeanits","BluePeanuts",e];if(!t?.whoami&&t?.templates&&"object"==typeof t.templates&&(t.whoami=e),t&&n.includes(t?.whoami)){if(this.G){if(t?.templates)for(const e of Object.keys(t.templates))this.G.templates[e]||(this.G.templates[e]=t.templates[e])}else this.G=t;await i(this,m,d).call(this,t).catch(t=>{})}}async St(t,e){this.G||(this.G=await this.xt()),this.G.templates[t]&&(this.G.templates[t].name=e);const[n,o]=t.split(" "),a=this.J.find(t=>t.H==Number(n)&&t.V===o);a&&(a.displayName=e),await i(this,m,c).call(this)}Ot(t){this.gt=t}async jt(t){const e=this.Mt();for(const n of e)await this.$t(n.key,t)}}(u,h,f),v=new class{constructor(t){this.Et=t,this.Lt=!1,this.Bt=[],this.Ft=[]}Pt(t){window.addEventListener("message",async e=>{const n=e.data,o=n.jsonData;if(!n||"blue-marble"!==n.source)return;if(!n.endpoint)return;const i=n.endpoint?.split("?")[0].split("/").filter(t=>t&&isNaN(Number(t))).filter(t=>t&&!t.includes(".")).pop();switch(i){case"me":if(o.status&&"2"!=o.status?.toString()[0])return void t.F("You are not logged in!\nCould not fetch userdata.");const e=Math.ceil(Math.pow(Math.floor(o.level)*Math.pow(30,.65),1/.65)-o.pixelsPainted);o.id||o.id,this.Et.ot=o.id,t.S("bm-Z",`Username: <b>${function(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}(o.name)}</b>`),t.S("bm-J",`Droplets: <b>${(new Intl.NumberFormat).format(o.droplets)}</b>`),t.S("bm-y",`Next level in <b>${(new Intl.NumberFormat).format(e)}</b> pixel${1==e?"":"s"}`);break;case"pixel":const i=n.endpoint.split("?")[0].split("/").filter(t=>t&&!isNaN(Number(t))),s=new URLSearchParams(n.endpoint.split("?")[1]),l=[s.get("x"),s.get("y")];if(this.Bt.length&&(!i.length||!l.length))return void t.F("Coordinates are malformed!\nDid you try clicking the canvas first?");this.Bt=[...i,...l];const m=(a=i,r=l,[parseInt(a[0])%4*1e3+parseInt(r[0]),parseInt(a[1])%4*1e3+parseInt(r[1])]);this.Et.st&&(t.S("bm-10",i[0]||""),t.S("bm-11",i[1]||""),t.S("bm-12",l[0]||""),t.S("bm-13",l[1]||""));const c=document.querySelectorAll("span");for(const t of c)if(t.textContent.trim().includes(`${m[0]}, ${m[1]}`)){let e=document.querySelector("#bm-x");const n=`(Tl X: ${i[0]}, Tl Y: ${i[1]}, Px X: ${l[0]}, Px Y: ${l[1]})`;e?e.textContent=n:(e=document.createElement("span"),e.id="bm-x",e.textContent=n,e.style="margin-left: calc(var(--spacing)*3); font-size: small;",t.parentNode.parentNode.parentNode.insertAdjacentElement("afterend",e))}break;case"tiles":let d=n.endpoint.split("/");d=[parseInt(d[d.length-2]),parseInt(d[d.length-1].replace(".png",""))];const b=n.blobID,p=n.blobData,u=await this.Et.It(p,d);window.postMessage({source:"blue-marble",blobID:b,blobData:u,blink:n.blink});break;case"robots":this.Lt="false"==o.userscript?.toString().toLowerCase()}var a,r})}}(w);f.p(v);var x={};try{x=JSON.parse(GM_getValue("bmTemplates","{}"))||{}}catch(t){x={}}if(!x.templates||0===Object.keys(x.templates||{}).length)try{const t=localStorage.getItem("BlueMarbleTemplates");if(t){const e=JSON.parse(t);e&&e.templates&&Object.keys(e.templates).length&&(x=e)}}catch(t){}Promise.resolve(w.Dt(x)).then(()=>{}).catch(t=>{}),function(){let t=!1;f.v({id:"bm-14",style:"top: 10px; right: 75px;"}).v({id:"bm-t"}).v({id:"bm-_"}).u().$({alt:"Blue Peanits Icon - Click to minimize/maximize",src:"https://raw.githubusercontent.com/MopigamesYT/BluePeanits/main/dist/assets/Favicon.png",style:"cursor: pointer;"},(e,n)=>{n.addEventListener("click",()=>{t=!t;const o=document.querySelector("#bm-14"),i=document.querySelector("#bm-t"),a=document.querySelector("#bm-_"),r=document.querySelector("#bm-u"),s=document.querySelector("#bm-D"),l=document.querySelector("#bm-c"),m=document.querySelector("#bm-E"),c=document.querySelector("#bm-K"),d=document.querySelector("#bm-L"),b=document.querySelector("#bm-z"),p=document.querySelectorAll("#bm-u input");t||(o.style.width="auto",o.style.maxWidth="300px",o.style.minWidth="200px",o.style.padding="10px"),["#bm-14 h1","#bm-j","#bm-14 hr","#bm-b > *:not(#bm-u)","#bm-8","#bm-1",`#${e.o}`].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.style.display=t?"none":""})}),t?(r&&(r.style.display="none"),s&&(s.style.display="none"),l&&(l.style.display="none"),m&&(m.style.display="none"),c&&(c.style.display="none"),d&&(d.style.display="none"),b&&(b.style.display="none"),p.forEach(t=>{t.style.display="none"}),o.style.width="60px",o.style.height="76px",o.style.maxWidth="60px",o.style.minWidth="60px",o.style.padding="8px",n.style.marginLeft="3px",i.style.textAlign="center",i.style.margin="0",i.style.marginBottom="0",a&&(a.style.display="",a.style.marginBottom="0.25em")):(r&&(r.style.display="",r.style.flexDirection="",r.style.justifyContent="",r.style.alignItems="",r.style.gap="",r.style.textAlign="",r.style.margin=""),s&&(s.style.display=""),l&&(l.style.display=""),m&&(m.style.display=""),c&&(c.style.display="",c.style.marginTop=""),d&&(d.style.display="",d.style.marginTop=""),b&&(b.style.display="",b.style.marginTop=""),p.forEach(t=>{t.style.display=""}),n.style.marginLeft="",o.style.padding="10px",i.style.textAlign="",i.style.margin="",i.style.marginBottom="",a&&(a.style.marginBottom="0.5em"),o.style.width="",o.style.height=""),n.alt=t?"Blue Peanits Icon - Minimized (Click to maximize)":"Blue Peanits Icon - Maximized (Click to minimize)"})}).u().C(1,{textContent:u}).u().u().M().u().v({id:"bm-j"}).k({id:"bm-Z",textContent:"Username:"}).u().k({id:"bm-J",textContent:"Droplets:"}).u().k({id:"bm-y",textContent:"Next level in..."}).u().u().M().u().v({id:"bm-b"}).v({id:"bm-u"}).v({id:"bm-k"}).A({id:"bm-D",className:"bm-17",style:"margin-top: 0;",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 6"><circle cx="2" cy="2" r="2"></circle><path d="M2 6 L3.7 3 L0.3 3 Z"></path><circle cx="2" cy="2" r="0.7" fill="white"></circle></svg></svg>'},(t,e)=>{e.onclick=()=>{const e=t.t?.Bt;e?.[0]?(t.S("bm-10",e?.[0]||""),t.S("bm-11",e?.[1]||""),t.S("bm-12",e?.[2]||""),t.S("bm-13",e?.[3]||"")):t.F("Coordinates are malformed! Did you try clicking on the canvas first?")}}).u().A({id:"bm-c",textContent:"AUTO",title:"Toggle automatic coordinate filling when clicking the map"},(t,e)=>{const n=()=>{t.t?.Et?.st?(e.classList.add("active"),e.title="Auto-coordinates ON - coordinates will be filled automatically when clicking the map"):(e.classList.remove("active"),e.title="Auto-coordinates OFF - click to enable automatic coordinate filling")};n(),e.onclick=()=>{if(t.t?.Et){t.t.Et.st=!t.t.Et.st,n();const e=t.t.Et.st?"enabled":"disabled";t.P(`Auto-coordinates ${e}!`)}}}).u().u().O({type:"number",id:"bm-10",placeholder:"Tl X",min:0,max:2047,step:1,required:!0}).u().O({type:"number",id:"bm-11",placeholder:"Tl Y",min:0,max:2047,step:1,required:!0}).u().O({type:"number",id:"bm-12",placeholder:"Px X",min:0,max:2047,step:1,required:!0}).u().O({type:"number",id:"bm-13",placeholder:"Px Y",min:0,max:2047,step:1,required:!0}).u().u().j({id:"bm-8",textContent:"Upload Template",accept:"image/png, image/jpeg, image/webp, image/bmp, image/gif"}).u().v({id:"bm-0"}).A({id:"bm-E",textContent:"Manage Templates"},(t,e)=>{const n=()=>{const n=t.t?.Et?.Mt()||[],o=n.filter(t=>t.enabled).length;e.textContent=n.length>0?`Manage (${o}/${n.length})`:"Manage Templates"};e.onclick=o=>{const i=document.querySelector("#bm-l"),a="none"!==i.style.display;if(o.shiftKey){const o=document.querySelector("#bm-14"),i=document.querySelector("#bm-r");if(i)i.remove(),e.style.backgroundColor="",e.style.fontWeight="";else{const i=document.createElement("div");i.id="bm-r",i.innerHTML='\n                  <hr style="margin: 1em 0;">\n                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">\n                    <h3 style="margin: 0; font-size: 1em;">Templates</h3>\n                    <button id="bm-3" style="background: #d32f2f; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9em;">×</button>\n                  </div>\n                  <div id="bm-4" style="max-height: 200px; overflow-y: auto; margin-bottom: 0.5em;"></div>\n                  <div style="display: flex; gap: 0.5em; font-size: 0.8em;">\n                    <button id="bm-h" style="flex: 1; padding: 0.3em;">Enable All</button>\n                    <button id="bm-d" style="flex: 1; padding: 0.3em;">Disable All</button>\n                  </div>\n                ',o.appendChild(i),document.querySelector("#bm-3").onclick=()=>{i.remove(),e.style.backgroundColor="",e.style.fontWeight=""},document.querySelector("#bm-h").onclick=async()=>{await(t.t?.Et?.jt(!0)),updateInlineList(),t.P("All templates enabled!")},document.querySelector("#bm-d").onclick=async()=>{await(t.t?.Et?.jt(!1)),updateInlineList(),t.P("All templates disabled!")},window.updateInlineList=()=>{const e=t.t?.Et?.Mt()||[],n=document.querySelector("#bm-4");0!==e.length?n.innerHTML=e.map(t=>`\n                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.3em; margin: 0.2em 0; background: rgba(0,0,0,0.2); border-radius: 3px; border-left: 2px solid ${t.enabled?"#4CAF50":"#f44336"};">\n                      <div style="flex: 1; min-width: 0;">\n                        <div style="font-size: 0.8em; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: ${t.enabled?"#fff":"#999"};">${t.name}</div>\n                        <div style="font-size: 0.7em; color: #bbb;">${t.coords}</div>\n                      </div>\n                      <div style="display: flex; gap: 0.2em;">\n                        <button onclick="toggleInlineTemplate('${t.key}', ${!t.enabled})" style="width: 25px; height: 25px; font-size: 0.8em; background: ${t.enabled?"#4CAF50":"#666"};">${t.enabled?"👁️":"👁️‍🗨️"}</button>\n                        <button onclick="deleteInlineTemplate('${t.key}', '${t.name}')" style="width: 25px; height: 25px; font-size: 0.8em; background: #d32f2f;">🗑️</button>\n                      </div>\n                    </div>\n                  `).join(""):n.innerHTML='<p style="text-align: center; color: #888; margin: 1em 0; font-size: 0.8em;">No templates</p>'},window.toggleInlineTemplate=async(e,o)=>{await(t.t?.Et?.$t(e,o)),updateInlineList(),n()},window.deleteInlineTemplate=async(e,o)=>{confirm(`Delete "${o}"?`)&&(await(t.t?.Et?.Tt(e)),updateInlineList(),n())},updateInlineList(),e.style.backgroundColor="#2e97ff",e.style.fontWeight="bold"}return}i.style.display=a?"none":"block",a?(e.style.backgroundColor="",e.style.fontWeight=""):(refreshTemplateList(),e.style.backgroundColor="#2e97ff",e.style.fontWeight="bold"),n()},n(),setInterval(n,2e3)}).u().A({id:"bm-L",textContent:"Enable All"},(t,e)=>{e.onclick=async()=>{await(t.t?.Et?.jt(!0)),window.refreshTemplateList&&refreshTemplateList(),t.P("Enabled all templates!")}}).u().A({id:"bm-K",textContent:"Create"},(t,e)=>{e.onclick=()=>{const e=document.querySelector("#bm-8"),n=document.querySelector("#bm-10");if(!n.checkValidity())return n.reportValidity(),void t.F("Coordinates are malformed! Did you try clicking on the canvas first?");const o=document.querySelector("#bm-11");if(!o.checkValidity())return o.reportValidity(),void t.F("Coordinates are malformed! Did you try clicking on the canvas first?");const i=document.querySelector("#bm-12");if(!i.checkValidity())return i.reportValidity(),void t.F("Coordinates are malformed! Did you try clicking on the canvas first?");const a=document.querySelector("#bm-13");if(!a.checkValidity())return a.reportValidity(),void t.F("Coordinates are malformed! Did you try clicking on the canvas first?");if(!e?.files[0])return void t.F("No file selected!");w.kt(e.files[0],e.files[0]?.name.replace(/\.[^/.]+$/,""),[Number(n.value),Number(o.value),Number(i.value),Number(a.value)]),setTimeout(()=>{window.refreshTemplateList&&refreshTemplateList()},100),t.P("Template created!"),e.value="";const r=e.parentElement.querySelector("button");r&&(r.textContent="Upload Template")}}).u().A({id:"bm-z",textContent:"Disable All"},(t,e)=>{e.onclick=async()=>{await(t.t?.Et?.jt(!1)),window.refreshTemplateList&&refreshTemplateList(),t.P("Disabled all templates!")}}).u().u().L({id:f.o,placeholder:`Status: Sleeping...\nVersion: ${h}`,readOnly:!0}).u().v({id:"bm-1"}).v().A({id:"bm-A",className:"bm-17",innerHTML:"🎨",title:"Template Color Converter"},(t,e)=>{e.addEventListener("click",()=>{window.open("https://pepoafonso.github.io/color_converter_wplace/","_blank","noopener noreferrer")})}).u().A({id:"bm-f",className:"bm-17",innerHTML:"🌙",title:"Toggle dark theme"},(t,e)=>{GM_getValue("darkTheme",!1)&&(document.body.classList.add("bm-V"),e.classList.add("active")),e.addEventListener("click",()=>{document.body.classList.contains("bm-V")?(document.body.classList.remove("bm-V"),e.classList.remove("active"),GM_setValue("darkTheme",!1)):(document.body.classList.add("bm-V"),e.classList.add("active"),GM_setValue("darkTheme",!0))})}).u().u().T({textContent:"Made by SwingTheVine - Modified by Mopi",style:"margin-top: auto;"}).u().u().u().h(document.body)}(),y.v({id:"bm-l",style:"top: 10px; left: 400px; display: none;"}).v({id:"bm-s"}).v({id:"bm-F"}).u().v({style:"display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;"}).C(2,{textContent:"Template Manager",style:"margin: 0; color: #fff;"}).u().A({id:"bm-w",textContent:"×",className:"bm-17",style:"font-size: large; margin: 0;"},(t,e)=>{e.onclick=()=>{const t=document.querySelector("#bm-E");document.querySelector("#bm-l").style.display="none",t&&(t.style.backgroundColor="",t.style.fontWeight="")}}).u().u().u().M({style:"margin: 0.5em 0;"}).u().v({id:"bm-g",style:"margin-bottom: 1em;"}).A({id:"bm-9",textContent:"Enable All"},(t,e)=>{e.onclick=async()=>{await w.jt(!0),refreshTemplateList(),f.P("All templates enabled!")}}).u().A({id:"bm-5",textContent:"Disable All"},(t,e)=>{e.onclick=async()=>{await w.jt(!1),refreshTemplateList(),f.P("All templates disabled!")}}).u().u().v({id:"bm-G",style:"max-height: 400px; overflow-y: auto; margin-bottom: 1em;"}).u().M({style:"margin: 0.5em 0;"}).u().v({id:"bm-v"}).k({id:"bm-6",textContent:"Total templates: 0",style:"margin: 0.25em 0; font-size: 0.9em;"}).u().k({id:"bm-2",textContent:"Enabled templates: 0",style:"margin: 0.25em 0; font-size: 0.9em;"}).u().T({textContent:"Shortcuts: Ctrl+T (toggle), Ctrl+Shift+E (enable all), Ctrl+Shift+D (disable all) • Shift+Click Manage for inline mode",style:"color: #aaa; font-size: 0.7em; margin-top: 0.5em; display: block; line-height: 1.3;"}).u().u().h(document.body),y.B("#bm-l","#bm-F"),window.refreshTemplateList=function(){const t=w.Mt(),e=document.querySelector("#bm-G"),n=document.querySelector("#bm-6"),o=document.querySelector("#bm-2");e.innerHTML="";const i=t.filter(t=>t.enabled);n.textContent=`Total templates: ${t.length}`,o.textContent=`Enabled templates: ${i.length}`,0!==t.length?t.forEach(t=>{const n=document.createElement("div");n.className="bm-H",n.style.cssText=`\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 0.75em;\n        margin: 0.5em 0;\n        background-color: rgba(0, 0, 0, 0.2);\n        border-radius: 6px;\n        border-left: 4px solid ${t.enabled?"#4CAF50":"#f44336"};\n        transition: all 0.2s ease;\n        min-height: 60px;\n      `;const o=document.createElement("div");o.style.cssText="flex: 1; min-width: 0; margin-right: 1em;";const i=document.createElement("div");i.textContent=t.name,i.style.cssText=`\n        font-weight: bold;\n        margin-bottom: 0.4em;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        color: ${t.enabled?"#fff":"#999"};\n        font-size: 1em;\n      `;const a=document.createElement("div");a.style.cssText="font-size: 0.8em; color: #bbb; line-height: 1.3;";const r=(new Intl.NumberFormat).format(t.pixelCount);a.innerHTML=`\n        <div>📍 ${t.coords}</div>\n        <div>🎨 ${r} pixels</div>\n      `,o.appendChild(i),o.appendChild(a);const s=document.createElement("div");s.style.cssText="display: flex; flex-direction: column; gap: 0.3em; align-items: center;";const l=document.createElement("button");l.textContent="ℹ️",l.title="Template information",l.className="bm-17",l.style.cssText="\n        width: 35px;\n        height: 35px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 1.1em;\n        background-color: #2196F3;\n      ",l.onclick=()=>{showTemplateInfo(t)};const m=document.createElement("button");m.textContent=t.enabled?"👁️":"👁️‍🗨️",m.title=t.enabled?"Hide template":"Show template",m.className="bm-17",m.style.cssText=`\n        width: 35px;\n        height: 35px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 1.2em;\n        background-color: ${t.enabled?"#4CAF50":"#666"};\n      `,m.onclick=async()=>{await w.$t(t.key,!t.enabled),refreshTemplateList(),f.P(`Template "${t.name}" ${t.enabled?"disabled":"enabled"}`)};const c=document.createElement("button");c.textContent="🗑️",c.title="Delete template",c.className="bm-17",c.style.cssText="\n        width: 35px;\n        height: 35px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 1.1em;\n        background-color: #d32f2f;\n      ",c.onclick=async()=>{confirm(`Are you sure you want to delete "${t.name}"?\n\nThis action cannot be undone.`)&&(await w.Tt(t.key),refreshTemplateList(),f.P(`Template "${t.name}" deleted`))},s.appendChild(l),s.appendChild(m),s.appendChild(c),n.appendChild(o),n.appendChild(s),e.appendChild(n)}):e.innerHTML='<div style="text-align: center; color: #888; margin: 2em 0; padding: 1em; background-color: rgba(0,0,0,0.1); border-radius: 4px; font-style: italic;">No templates loaded<br><small>Create templates using the main interface</small></div>'},window.showTemplateInfo=async function(t){let e=document.querySelector("#bm-I");e||(e=document.createElement("div"),e.id="bm-I",e.style.cssText="top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;",document.body.appendChild(e));const n=w.J.find(e=>`${e.H} ${e.V}`===t.key);e.innerHTML=`\n      <div class="info-header">\n        <h2 style="margin: 0; color: #fff;">Template Information</h2>\n        <button id="bm-W" class="bm-17" style="width: 30px; height: 30px; background: #d32f2f; font-size: 1.2em;">×</button>\n      </div>\n      \n      <div class="info-section">\n        <h4>📋 Basic Information</h4>\n        <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5em 1em; font-size: 0.9em;">\n          <strong>Name:</strong> \n          <div style="display: flex; gap: 0.5em; align-items: center;">\n            <span id="bm-i">${t.name}</span>\n            <button id="bm-B" class="bm-17" style="width: 25px; height: 25px; background: #2196F3; font-size: 0.8em;">✏️</button>\n          </div>\n          <strong>Coordinates:</strong> \n          <div style="display: flex; gap: 0.5em; align-items: center;">\n            <span id="bm-a">${t.coords}</span>\n            <button id="bm-m" class="bm-17" style="width: 25px; height: 25px; background: #2196F3; font-size: 0.8em;">✏️</button>\n          </div>\n          <strong>Status:</strong> <span style="color: ${t.enabled?"#4CAF50":"#f44336"};">${t.enabled?"Enabled":"Disabled"}</span>\n          <strong>Template ID:</strong> <span>${t.key}</span>\n        </div>\n        <div id="bm-n" style="display: none; margin-top: 1em; padding: 1em; background: rgba(0,0,0,0.3); border-radius: 4px;">\n          <div style="margin-bottom: 0.5em; font-weight: bold;">Edit Template Name:</div>\n          <div style="display: flex; gap: 0.5em; align-items: center;">\n            <input type="text" id="bm-X" value="${t.name}" style="flex: 1; padding: 0.3em; background: #333; border: 1px solid #666; color: white; border-radius: 3px;">\n            <button id="bm--" style="padding: 0.3em 0.6em; background: #4CAF50; border: none; color: white; border-radius: 3px; cursor: pointer;">Save</button>\n            <button id="bm-R" style="padding: 0.3em 0.6em; background: #666; border: none; color: white; border-radius: 3px; cursor: pointer;">Cancel</button>\n          </div>\n        </div>\n        <div id="bm-e" style="display: none; margin-top: 1em; padding: 1em; background: rgba(0,0,0,0.3); border-radius: 4px;">\n          <div style="margin-bottom: 0.5em; font-weight: bold;">Edit Coordinates:</div>\n          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5em; margin-bottom: 0.5em;">\n            <input type="number" id="bm-P" placeholder="Tile X" min="0" max="2047" style="padding: 0.3em; background: #333; border: 1px solid #666; color: white; border-radius: 3px;">\n            <input type="number" id="bm-Q" placeholder="Tile Y" min="0" max="2047" style="padding: 0.3em; background: #333; border: 1px solid #666; color: white; border-radius: 3px;">\n            <input type="number" id="bm-M" placeholder="Pixel X" min="0" max="999" style="padding: 0.3em; background: #333; border: 1px solid #666; color: white; border-radius: 3px;">\n            <input type="number" id="bm-N" placeholder="Pixel Y" min="0" max="999" style="padding: 0.3em; background: #333; border: 1px solid #666; color: white; border-radius: 3px;">\n          </div>\n          <div style="display: flex; gap: 0.5em;">\n            <button id="bm-S" style="flex: 1; padding: 0.5em; background: #4CAF50; border: none; color: white; border-radius: 3px; cursor: pointer;">Save</button>\n            <button id="bm-O" style="flex: 1; padding: 0.5em; background: #666; border: none; color: white; border-radius: 3px; cursor: pointer;">Cancel</button>\n          </div>\n        </div>\n      </div>\n\n      <div class="info-section">\n        <h4>📊 Statistics</h4>\n        <div class="info-stats">\n          <div class="stat-item">\n            <div class="stat-value">${(new Intl.NumberFormat).format(t.pixelCount)}</div>\n            <div class="stat-label">Total Pixels</div>\n          </div>\n          <div class="stat-item">\n            <div class="stat-value" id="bm-Y">Loading...</div>\n            <div class="stat-label">Tiles Used</div>\n          </div>\n        </div>\n      </div>\n\n      <div class="info-section">\n        <h4>🎨 Template Preview</h4>\n        <div class="info-preview">\n          <div id="bm-7">Generating preview...</div>\n        </div>\n      </div>\n\n      <div class="info-section">\n        <h4>🌈 Color Analysis</h4>\n        <div id="bm-T">Analyzing colors...</div>\n      </div>\n    `,e.style.display="block",document.getElementById("bm-W").onclick=()=>{e.style.display="none"};const o=document.getElementById("bm-m"),i=document.getElementById("bm-e"),a=document.getElementById("bm-a"),r={Ht:document.getElementById("bm-P"),Vt:document.getElementById("bm-Q"),Xt:document.getElementById("bm-M"),Yt:document.getElementById("bm-N")},s=t.coords.split(",").map(t=>parseInt(t.trim()));o.onclick=()=>{r.Ht.value=s[0]||"",r.Vt.value=s[1]||"",r.Xt.value=s[2]||"",r.Yt.value=s[3]||"",i.style.display="block",o.style.display="none"},document.getElementById("bm-O").onclick=()=>{i.style.display="none",o.style.display="inline-block"},document.getElementById("bm-S").onclick=async()=>{try{const e=[parseInt(r.Ht.value),parseInt(r.Vt.value),parseInt(r.Xt.value),parseInt(r.Yt.value)];if(e.some(t=>isNaN(t)||t<0))throw new Error("All coordinates must be non-negative numbers");if(e[0]>2047||e[1]>2047)throw new Error("Tile coordinates must be between 0-2047");if(e[2]>999||e[3]>999)throw new Error("Pixel coordinates must be between 0-999");const n=await w.Ct(t.key,e),s=e.join(", ");a.textContent=s,t.coords=s,i.style.display="none",o.style.display="inline-block",window.refreshTemplateList&&refreshTemplateList(),f.P(n)}catch(t){alert(`Failed to update coordinates: ${t.message}`)}};const l=document.getElementById("bm-B"),m=document.getElementById("bm-n"),c=document.getElementById("bm-i"),d=document.getElementById("bm-X");if(l.onclick=()=>{d.value=t.name,m.style.display="block",l.style.display="none"},document.getElementById("bm-R").onclick=()=>{m.style.display="none",l.style.display="inline-block"},document.getElementById("bm--").onclick=async()=>{try{const e=d.value.trim();if(!e)throw new Error("Template name cannot be empty");if(e.length>100)throw new Error("Template name must be 100 characters or less");await w.St(t.key,e),c.textContent=e,t.name=e,m.style.display="none",l.style.display="inline-block",window.refreshTemplateList&&refreshTemplateList(),f.P(`Template renamed to "${e}"`)}catch(t){alert(`Failed to update name: ${t.message}`)}},n&&n.X){const t=Object.keys(n.X).length;document.getElementById("bm-Y").textContent=t;try{const{Rt:t,Ut:e}=await async function(t){if(!t.X)return{Rt:null,Ut:[]};const e=document.createElement("canvas"),n=e.getContext("2d"),o=new Map;let i=0,a=1/0,r=1/0,s=-1/0,l=-1/0;for(const[e,n]of Object.entries(t.X)){const[t,m,c,d]=e.split(",").map(Number);a=Math.min(a,parseInt(c)),r=Math.min(r,parseInt(d)),s=Math.max(s,parseInt(c)+n.width/3),l=Math.max(l,parseInt(d)+n.height/3);const b=document.createElement("canvas"),p=b.getContext("2d");b.width=n.width,b.height=n.height,p.drawImage(n,0,0);const u=p.getImageData(0,0,n.width,n.height).data;for(let t=1;t<n.height;t+=3)for(let e=1;e<n.width;e+=3){const a=4*(t*n.width+e);if(u[a+3]>0){const t=u[a],e=u[a+1],n=u[a+2],r=`#${t.toString(16).padStart(2,"0")}${e.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`;o.set(r,(o.get(r)||0)+1),i++}}}let m=null;if(a!==1/0){const o=Math.min(400,s-a),i=Math.min(300,l-r),c=Math.min(o/(s-a),i/(l-r));e.width=(s-a)*c,e.height=(l-r)*c,n.imageSmoothingEnabled=!1;for(const[e,o]of Object.entries(t.X)){const[t,i,s,l]=e.split(",").map(Number),m=(parseInt(s)-a)*c,d=(parseInt(l)-r)*c,b=o.width/3*c,p=o.height/3*c;n.drawImage(o,m,d,b,p)}m=e}return{Rt:m,Ut:Array.from(o.entries()).map(([t,e])=>({qt:t,count:e,_t:(e/i*100).toFixed(1)})).sort((t,e)=>e.count-t.count).slice(0,20)}}(n),o=document.getElementById("bm-7");t?(o.innerHTML="",o.appendChild(t)):o.textContent="Preview not available";const i=document.getElementById("bm-T");if(e&&e.length>0){const t=e.reduce((t,e)=>t+e.count,0);i.innerHTML=`\n            <div style="margin-bottom: 0.5em; font-size: 0.9em;">\n              <strong>Unique Colors:</strong> ${e.length} | \n              <strong>Analyzed Pixels:</strong> ${(new Intl.NumberFormat).format(t)}\n            </div>\n            <div class="color-grid">\n              ${e.map(t=>`\n                <div class="color-item">\n                  <div class="color-swatch" style="background-color: ${t.qt};"></div>\n                  <div class="color-info">\n                    <div style="font-weight: bold;">${t.qt}</div>\n                    <div>${t.count} px (${t._t}%)</div>\n                  </div>\n                </div>\n              `).join("")}\n            </div>\n          `}else i.textContent="No color data available"}catch(t){document.getElementById("bm-7").textContent="Analysis failed",document.getElementById("bm-T").textContent="Color analysis failed"}}},f.B("#bm-14","#bm-_"),v.Pt(f),new MutationObserver((t,e)=>{const n=document.querySelector("#color-1");if(!n)return;let o=document.querySelector("#bm-U");if(!o){o=document.createElement("button"),o.id="bm-U",o.textContent="Move ↑",o.className="btn btn-soft",o.onclick=function(){const t=this.parentNode.parentNode.parentNode.parentNode,e="Move ↑"==this.textContent;t.parentNode.className=t.parentNode.className.replace(e?"bottom":"top",e?"top":"bottom"),t.style.borderTopLeftRadius=e?"0px":"var(--radius-box)",t.style.borderTopRightRadius=e?"0px":"var(--radius-box)",t.style.borderBottomLeftRadius=e?"var(--radius-box)":"0px",t.style.borderBottomRightRadius=e?"var(--radius-box)":"0px",this.textContent=e?"Move ↓":"Move ↑"};const t=n.parentNode.parentNode.parentNode.parentNode.querySelector("h2");t.parentNode?.appendChild(o)}}).observe(document.body,{childList:!0,subtree:!0}),document.addEventListener("keydown",t=>{if("INPUT"!==document.activeElement.tagName&&"TEXTAREA"!==document.activeElement.tagName){if(t.ctrlKey&&"t"===t.key){t.preventDefault();const e=document.querySelector("#bm-l"),n=document.querySelector("#bm-E");if(e){const t="none"!==e.style.display;e.style.display=t?"none":"block",t?n&&(n.style.backgroundColor="",n.style.fontWeight=""):(window.refreshTemplateList&&refreshTemplateList(),n&&(n.style.backgroundColor="#2e97ff",n.style.fontWeight="bold"))}}t.ctrlKey&&t.shiftKey&&"E"===t.key&&(t.preventDefault(),w&&w.jt&&(w.jt(!0),window.refreshTemplateList&&refreshTemplateList(),f.P("All templates enabled via keyboard shortcut!"))),t.ctrlKey&&t.shiftKey&&"D"===t.key&&(t.preventDefault(),w&&w.jt&&(w.jt(!1),window.refreshTemplateList&&refreshTemplateList(),f.P("All templates disabled via keyboard shortcut!")))}}),function(...t){(0,console.log)(...t)}(`%c${u}%c (${h}) userscript has loaded!`,"color: cornflowerblue;","")})();